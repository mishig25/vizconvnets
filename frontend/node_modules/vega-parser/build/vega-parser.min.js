!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-dataflow"),require("vega-expression"),require("vega-statistics"),require("d3-color"),require("d3-array"),require("d3-format"),require("d3-time-format"),require("vega-scale"),require("vega-scenegraph"),require("d3-geo"),require("vega-event-selector")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-expression","vega-statistics","d3-color","d3-array","d3-format","d3-time-format","vega-scale","vega-scenegraph","d3-geo","vega-event-selector"],t):t(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.vega,e.d3,e.d3,e.d3,e.d3,e.vega,e.vega,e.d3,e.vega)}(this,function(e,t,n,a,r,i,o,l,s,u,d,f,c){"use strict";var p=function(e,n){return e=e||n.autosize,t.isObject(e)?e:{type:e=e||"pad"}},g=function(e,n){return e=e||n.padding,t.isObject(e)?{top:h(e.top),bottom:h(e.bottom),left:h(e.left),right:h(e.right)}:{top:a=h(e),bottom:a,left:a,right:a};var a};function h(e){return+e||0}var m=["value","update","react","bind"];function v(e,n){t.error(e+' for "outer" push: '+t.stringValue(n))}var y=function(e,t){var n=e.name;if("outer"===e.push)t.signals[n]||v("No prior signal definition",n),m.forEach(function(t){void 0!==e[t]&&v("Invalid property ",t)});else{var a=t.addSignal(n,e.value);!1===e.react&&(a.react=!1),e.bind&&t.addBinding(n,e.bind)}},b={};function x(e,t,n){var a=e+":"+n,r=b[a];return r&&r[0]===t||(b[a]=r=[t,t(n)]),r[1]}function k(e,t){return x("timeFormat",s.timeFormat,t)(e)}var S=new Date(2e3,0,1);function R(e,t,n){return S.setMonth(e),S.setDate(t),k(S,n)}function w(e,t,n){try{e[t].apply(e,["EXPRESSION"].concat([].slice.call(n)))}catch(t){e.warn(t)}return n[n.length-1]}var O="undefined"!=typeof window&&window||null;var z="Literal",P="Identifier",j="@",D="%",$=":";function E(e,n){var a;return t.isFunction(e)?e:t.isString(e)?(a=n.scales[e])&&a.value:void 0}function _(e,t,n){var a=D+n;if(!t.hasOwnProperty(a))try{t[a]=e.scaleRef(n)}catch(e){}}function V(e,t,n,a){if(t[0].type===z)_(n,a,t[0].value);else if(t[0].type===P)for(e in n.scales)_(n,a,e)}function F(e,t){return function(n,a,r){if(n){var i=E(n,(r||this).context);return i&&i.path[e](a)}return t(a)}}var A=F("area",f.geoArea),W=F("bounds",f.geoBounds),M=F("centroid",f.geoCentroid);function L(e){var t=this.context.data[e];return t?t.values.value:[]}function C(e,n,a,r){n[0].type!==z&&t.error("First argument to data functions must be a string literal.");var i=n[0].value,o=$+i;r.hasOwnProperty(o)||(r[o]=a.getData(i).tuplesRef())}var q={};function B(e){return e.data}function N(e,t){var n=L.call(t,e);return n.root&&n.root.lookup||q}var U=function(e,t,n,a){var r,i=t[0],o=t[t.length-1];return i>o&&(r=i,i=o,o=r),a=void 0===a||a,((n=void 0===n||n)?i<=e:i<e)&&(a?e<=o:e<o)};function T(e,n){return e===n||e!=e&&n!=n||!(!t.isArray(e)||!t.isArray(n)||e.length!==n.length)&&function(e,t){for(var n=0,a=e.length;n<a;++n)if(!T(e[n],t[n]))return!1;return!0}(e,n)}function I(e){return function(t){for(var n in e)if(!T(t[n],e[n]))return!1;return!0}}var X="bin_",H="intersect",Y="union",G="index:unit";function J(e,n){for(var a,r=n.fields,i=n.values,o=n.getter||(n.getter=[]),l=r.length,s=0;s<l;++s)if(o[s]=o[s]||t.field(r[s]),a=o[s](e),t.isDate(a)&&(a=t.toNumber(a)),t.isDate(i[s])&&(i[s]=t.toNumber(i[s])),n[X+r[s]]){if(t.isDate(i[s][0])&&(i[s]=i[s].map(t.toNumber)),!U(a,i[s],!0,!1))return!1}else if(a!==i[s])return!1;return!0}function K(e,n){for(var a,r,i=n.intervals,o=i.length,l=0;l<o;++l){if(a=i[l].extent,r=(i[l].getter||(i[l].getter=t.field(i[l].field)))(e),!a||a[0]===a[1])return!1;if(t.isDate(r)&&(r=t.toNumber(r)),t.isDate(a[0])&&(a=i[l].extent=a.map(t.toNumber)),t.isNumber(a[0])&&!U(r,a))return!1;if(t.isString(a[0])&&a.indexOf(r)<0)return!1}return!0}function Q(e,t,n,a){for(var r,i,o,l,s,u=this.context.data[e],d=u?u.values.value:[],f=u?u[G]&&u[G].value:void 0,c=n===H,p=d.length,g=0;g<p;++g)if(r=d[g],f&&c){if(-1===(o=(i=i||{})[l=r.unit]||0))continue;if(s=a(t,r),i[l]=s?-1:++o,s&&1===f.size)return!0;if(!s&&o===f.get(l).count)return!1}else if(c^(s=a(t,r)))return s;return p&&c}function Z(e,t,n){return Q.call(this,e,t,n,J)}function ee(e,n,a,r){n[0].type!==z&&t.error("First argument to indata must be a string literal.");var i=n[0].value,o=n.length>=2&&n[n.length-1].value,l=j+"unit";o!==H||r.hasOwnProperty(l)||(r[l]=a.getData(i).indataRef(a,"unit")),C(0,n,a,r)}function te(e,t,n,a){var r,i,o,l,s,u=this.context.data[e],d=u?u.values.value:[],f=u?u[G]&&u[G].value:void 0,c=d[0],p=0;if(c){for(r=t?c.encodings.length:c.fields.length;p<r;++p)if(t&&c.encodings[p]===t||n&&c.fields[p]===n){i=p,l=c[X+c.fields[p]];break}return f&&1===f.size&&(a=Y),f&&a===H?(s=d.reduce(function(e,t){return(e[t.unit]||(e[t.unit]=[])).push({unit:t.unit,value:t.values[i]}),e},{}),o=Object.keys(s).map(function(e){return{unit:e,value:l?ae(s[e],Y):ne(s[e],Y)}})):o=d.map(function(e){return{unit:e.unit,value:e.values[i]}}),l?ae(o,a):ne(o,a)}}function ne(e,t){for(var n,a,r,i,o={},l=0,s={},u=[],d=0,f=e.length;d<f;++d)a=(n=e[d]).unit,i=n.value,o[a]||(o[a]=++l),(r=s[i])||(s[i]=r={value:i,units:{},count:0}),r.units[a]||(r.units[a]=++r.count);for(i in s)r=s[i],t===H&&r.count!==l||u.push(r.value);return u.length?u:void 0}function ae(e,n){for(var a,r,i,o,l=n===H?ie:re,s=0,u=e.length;s<u;++s)a=e[s].value,t.isDate(a[0])&&(a=a.map(t.toNumber)),(i=a[0])>(o=a[1])&&(o=a[0],i=a[1]),r=r?l(r,i,o):[i,o];return r&&r.length&&+r[0]!=+r[1]?r:void 0}function re(e,t,n){return e[0]>t&&(e[0]=t),e[1]<n&&(e[1]=n),e}function ie(e,t,n){return n<e[0]||e[1]<t?[]:(e[0]<t&&(e[0]=t),e[1]>n&&(e[1]=n),e)}var oe={random:function(){return r.random()},isArray:t.isArray,isBoolean:t.isBoolean,isDate:t.isDate,isNumber:t.isNumber,isObject:t.isObject,isRegExp:t.isRegExp,isString:t.isString,isTuple:n.isTuple,toBoolean:t.toBoolean,toDate:t.toDate,toNumber:t.toNumber,toString:t.toString,pad:t.pad,peek:t.peek,truncate:t.truncate,rgb:i.rgb,lab:i.lab,hcl:i.hcl,hsl:i.hsl,sequence:o.range,format:function(e,t){return x("format",l.format,t)(e)},utcFormat:function(e,t){return x("utcFormat",s.utcFormat,t)(e)},utcParse:function(e,t){return x("utcParse",s.utcParse,t)(e)},timeFormat:k,timeParse:function(e,t){return x("timeParse",s.timeParse,t)(e)},monthFormat:function(e){return R(e,1,"%B")},monthAbbrevFormat:function(e){return R(e,1,"%b")},dayFormat:function(e){return R(0,2+e,"%A")},dayAbbrevFormat:function(e){return R(0,2+e,"%a")},quarter:function(e){return 1+~~(new Date(e).getMonth()/3)},utcquarter:function(e){return 1+~~(new Date(e).getUTCMonth()/3)},warn:function(){return w(this.context.dataflow,"warn",arguments)},info:function(){return w(this.context.dataflow,"info",arguments)},debug:function(){return w(this.context.dataflow,"debug",arguments)},inScope:function(e){var t=this.context.group,n=!1;if(t)for(;e;){if(e===t){n=!0;break}e=e.mark.group}return n},clampRange:function(e,t,n){var a,r=e[0],i=e[1];return i<r&&(a=i,i=r,r=a),(a=i-r)>=n-t?[t,n]:[Math.min(Math.max(r,t),n-a),Math.min(Math.max(i,a),n)]},pinchDistance:function(e){var t=e.touches,n=t[0].clientX-t[1].clientX,a=t[0].clientY-t[1].clientY;return Math.sqrt(n*n+a*a)},pinchAngle:function(e){var t=e.touches;return Math.atan2(t[0].clientY-t[1].clientY,t[0].clientX-t[1].clientX)},screen:function(){return O?O.screen:{}},containerSize:function(){var e=this.context.dataflow,t=e.container&&e.container();return t?[t.clientWidth,t.clientHeight]:[void 0,void 0]},windowSize:function(){return O?[O.innerWidth,O.innerHeight]:[void 0,void 0]},span:function(e){return e[e.length-1]-e[0]||0},flush:function(e,n,a,r,i,o){var l=Math.abs(n-e[0]),s=Math.abs(t.peek(e)-n);return l<s&&l<=a?r:s<=a?i:o},bandspace:function(e,t,n){return u.bandSpace(e||0,t||0,n||0)},inrange:U,setdata:function(e,n){var a=this.context.dataflow,r=this.context.data[e].input;return a.pulse(r,a.changeset().remove(t.truthy).insert(n)),1},pathShape:function(e){var t=null;return function(n){return n?d.pathRender(n,t=t||d.pathParse(e)):e}},panLinear:t.panLinear,panLog:t.panLog,panPow:t.panPow,zoomLinear:t.zoomLinear,zoomLog:t.zoomLog,zoomPow:t.zoomPow,encode:function(e,t,n){if(e){var a=this.context.dataflow,r=e.mark.source;a.pulse(r,a.changeset().encode(e,t))}return void 0!==n?n:e},modify:function(e,a,r,i,o,l){var s,u,d=this.context.dataflow,f=this.context.data[e],c=f.input,p=f.changes,g=d.stamp();if(!1===d._trigger||!(c.value.length||a||i))return 0;if((!p||p.stamp<g)&&(f.changes=p=d.changeset(),p.stamp=g,d.runAfter(function(){f.modified=!0,d.pulse(c,p).run()},!0,1)),r&&(s=!0===r?t.truthy:t.isArray(r)||n.isTuple(r)?r:I(r),p.remove(s)),a&&p.insert(a),i&&(s=I(i),c.value.some(s)?p.remove(s):p.insert(i)),o)for(u in l)p.modify(o,u,l[u]);return 1}},le=["view","item","group","xy","x","y"],se="event.vega.",ue="this.",de={};function fe(e,t,n){return 1===arguments.length?oe[e]:(oe[e]=t,n&&(de[e]=n),pe&&(pe.functions[e]=ue+e),this)}fe("bandwidth",function(e,t){var n=E(e,(t||this).context);return n&&n.bandwidth?n.bandwidth():0},V),fe("copy",function(e,t){var n=E(e,(t||this).context);return n?n.copy():void 0},V),fe("domain",function(e,t){var n=E(e,(t||this).context);return n?n.domain():[]},V),fe("range",function(e,t){var n=E(e,(t||this).context);return n&&n.range?n.range():[]},V),fe("invert",function(e,n,a){var r=E(e,(a||this).context);return r?t.isArray(n)?(r.invertRange||r.invert)(n):(r.invert||r.invertExtent)(n):void 0},V),fe("scale",function(e,t,n){var a=E(e,(n||this).context);return a?a(t):void 0},V),fe("gradient",function(e,t,n,a,r){e=E(e,(r||this).context);var i=d.Gradient(t,n),o=e.domain(),l=o[0],s=o[o.length-1],f=u.scaleFraction(e,l,s);e.ticks&&(l!==(o=e.ticks(+a||15))[0]&&o.unshift(l),s!==o[o.length-1]&&o.push(s));for(var c=0,p=o.length;c<p;++c)i.stop(f(o[c]),e(o[c]));return i},V),fe("geoArea",A,V),fe("geoBounds",W,V),fe("geoCentroid",M,V),fe("geoShape",function(e,t,n){var a=E(e,(n||this).context);return function(e){return a?a.path.context(e)(t):""}},V),fe("indata",function(e,t,n){var a=this.context.data[e]["index:"+t],r=a?a.value.get(n):void 0;return r?r.count:r},function(e,n,a,r){n[0].type!==z&&t.error("First argument to indata must be a string literal."),n[1].type!==z&&t.error("Second argument to indata must be a string literal.");var i=n[0].value,o=n[1].value,l=j+o;r.hasOwnProperty(l)||(r[l]=a.getData(i).indataRef(a,o))}),fe("data",L,C),fe("vlSingle",Z,C),fe("vlSingleDomain",te,C),fe("vlMulti",Z,ee),fe("vlMultiDomain",te,ee),fe("vlInterval",function(e,t,n){return Q.call(this,e,t,n,K)},C),fe("vlIntervalDomain",function(e,t,n,a){var r,i,o,l,s,u=this.context.data[e],d=u?u.values.value:[],f=d[0],c=0;if(f){for(r=f.intervals.length;c<r;++c)if(i=f.intervals[c],t&&i.encoding===t||n&&i.field===n){if(!i.extent)return;o=c,s=i.extent.length>2;break}return l=d.reduce(function(e,t){var n=t.intervals[o].extent,a=s?n.map(function(e){return{unit:t.unit,value:e}}):{unit:t.unit,value:n};return s?e.push.apply(e,a):e.push(a),e},[]),s?ne(l,a):ae(l,a)}},C),fe("treePath",function(e,t,n){var a=N(e,this),r=a[t],i=a[n];return r&&i?r.path(i).map(B):void 0},C),fe("treeAncestors",function(e,t){var n=N(e,this)[t];return n?n.ancestors().map(B):void 0},C);var ce={blacklist:["_"],whitelist:["datum","event","item"],fieldvar:"datum",globalvar:function(e){return"_["+t.stringValue("$"+e)+"]"},functions:function(e){var t=a.functions(e);for(var n in le.forEach(function(e){t[e]=se+e}),oe)t[n]=ue+n;return t},constants:a.constants,visitors:de},pe=a.codegen(ce),ge=function(e,n,r){var i,o,l={};try{i=a.parse(e)}catch(n){t.error("Expression parse error: "+t.stringValue(e))}return i.visit(function(e){if("CallExpression"===e.type){var t=e.callee.name,a=ce.visitors[t];a&&a(t,e.arguments,n,l)}}),(o=pe(i)).globals.forEach(function(e){var t="$"+e;!l.hasOwnProperty(t)&&n.getSignal(e)&&(l[t]=n.signalRef(e))}),{$expr:r?r+"return("+o.code+");":o.code,$fields:o.fields,$params:l}},he="view",me="scope",ve=function(e,t){return e.signal?t.getSignal(e.signal).id:e.scale?t.getScale(e.scale).id:ye(e,t)};function ye(e,n){return(e.merge?be:e.stream?xe:e.type?ke:t.error("Invalid stream specification: "+t.stringValue(e)))(e,n)}function be(e,t){var n=Se({merge:e.merge.map(function(e){return ye(e,t)})},e,t);return t.addStream(n).id}function xe(e,t){var n=Se({stream:ye(e.stream,t)},e,t);return t.addStream(n).id}function ke(e,t){var n,a=t.event((n=e.source)===me?he:n||he,e.type),r=Se({stream:a},e,t);return 1===Object.keys(r).length?a:t.addStream(r).id}function Se(e,n,a){var r,i,o,l,s=n.between;return s&&(2!==s.length&&t.error('Stream "between" parameter must have 2 entries: '+t.stringValue(n)),e.between=[ye(s[0],a),ye(s[1],a)]),s=n.filter?t.array(n.filter):[],(n.marktype||n.markname||n.markrole)&&s.push((r=n.marktype,i=n.markname,o=n.markrole,(l="event.item")+(r&&"*"!==r?"&&"+l+".mark.marktype==='"+r+"'":"")+(o?"&&"+l+".mark.role==='"+o+"'":"")+(i?"&&"+l+".mark.name==='"+i+"'":""))),n.source===me&&s.push("inScope(event.item)"),s.length&&(e.filter=ge("("+s.join(")&&(")+")").$expr),null!=(s=n.throttle)&&(e.throttle=+s),null!=(s=n.debounce)&&(e.debounce=+s),n.consume&&(e.consume=!0),e}var Re="var datum=event.item&&event.item.datum;",we=function(e,n){var a=n.getSignal(e.name);if(e.update){var r=ge(e.update,n);a.update=r.$expr,a.params=r.$params}e.on&&e.on.forEach(function(e){var r,i,o,l,s,u,d,f,p;r=e,i=n,o=a.id,u=r.events,d=r.update,f=r.encode,p=[],u||t.error("Signal update missing events specification."),t.isString(u)&&(u=c.selector(u)),(u=t.array(u).filter(function(e){return e.signal||e.scale?(p.push(e),0):1})).length&&p.push(u.length>1?{merge:u}:u[0]),null!=f&&(d&&t.error("Signal encode and update are mutually exclusive."),d="encode(item(),"+t.stringValue(f)+")"),l=t.isString(d)?ge(d,i,Re):null!=d.expr?ge(d.expr,i,Re):null!=d.value?d.value:null!=d.signal?{$expr:"_.value",$params:{value:i.signalRef(d.signal)}}:t.error("Invalid signal update specification."),s={target:o,update:l},r.force&&(s.options={force:!0}),p.forEach(function(e){e={source:ve(e,i)},i.addUpdate(t.extend(e,s))})})};function Oe(e,t,n,a){this.id=-1,this.type=e,this.value=t,this.params=n,a&&(this.parent=a)}function ze(e,t,n,a){return new Oe(e,t,n,a)}function Pe(e,t){return ze("operator",e,t)}function je(e){var t={$ref:e.id};return e.id<0&&(e.refs=e.refs||[]).push(t),t}var De={$tupleid:1,toString:function(){return":_tupleid_:"}};function $e(e,t){return t?{$field:e,$name:t}:{$field:e}}var Ee=$e("key");function _e(e,t){return{$compare:e,$order:t}}var Ve="descending";function Fe(e,t){return(e&&e.signal?"$"+e.signal:e||"")+(e&&t?"_":"")+(t&&t.signal?"$"+t.signal:t||"")}function Ae(e){return e&&e.signal}function We(e,t){return null!=e?e:t}function Me(e){return function(t,n,a){return ze(e,n,t||void 0,a)}}var Le=Me("aggregate"),Ce=Me("axisticks"),qe=Me("bound"),Be=Me("collect"),Ne=Me("compare"),Ue=Me("datajoin"),Te=Me("encode"),Ie=Me("facet"),Xe=Me("field"),He=Me("key"),Ye=Me("legendentries"),Ge=Me("mark"),Je=Me("multiextent"),Ke=Me("multivalues"),Qe=Me("overlap"),Ze=Me("params"),et=Me("prefacet"),tt=Me("projection"),nt=Me("proxy"),at=Me("relay"),rt=Me("render"),it=Me("scale"),ot=Me("sieve"),lt=Me("sortitems"),st=Me("viewlayout"),ut=Me("values"),dt=0,ft=["identity","ordinal","band","point","bin-linear","bin-ordinal","linear","pow","sqrt","log","sequential","time","utc","quantize","quantile","threshold"],ct=t.toSet(ft),pt=t.toSet(ft.slice(1,6));function gt(e){return pt.hasOwnProperty(e)}function ht(e){return"quantile"===e}function mt(e,n){var a,r,i,o,l=n.getScale(e.name).params;for(a in l.domain=bt(e.domain,e,n),null!=e.range&&(l.range=function e(n,a,r){var i=n.range,o=a.config.range;{if(i.signal)return a.signalRef(i.signal);if(t.isString(i)){if(o&&o.hasOwnProperty(i))return n=t.extend({},n,{range:o[i]}),e(n,a,r);"width"===i?i=[0,{signal:"width"}]:"height"===i?i=gt(n.type)?[0,{signal:"height"}]:[{signal:"height"},0]:t.error("Unrecognized scale range value: "+t.stringValue(i))}else{if(i.scheme)return r.scheme=vt(i.scheme,a),i.extent&&(r.schemeExtent=(l=i.extent,s=a,l.signal?s.signalRef(l.signal):l.map(function(e){return vt(e,s)}))),void(i.count&&(r.schemeCount=vt(i.count,a)));if(i.step)return void(r.rangeStep=vt(i.step,a));if(gt(n.type)&&!t.isArray(i))return bt(i,n,a);t.isArray(i)||t.error("Unsupported range type: "+t.stringValue(i))}}var l,s;return i.map(function(e){return vt(e,a)})}(e,n,l)),null!=e.interpolate&&(r=e.interpolate,(i=l).interpolate=vt(r.type||r),null!=r.gamma&&(i.interpolateGamma=vt(r.gamma))),null!=e.nice&&(o=e.nice,l.nice=t.isObject(o)?{interval:vt(o.interval),step:vt(o.step)}:vt(o)),e)l.hasOwnProperty(a)||"name"===a||(l[a]=vt(e[a],n))}function vt(e,n){return t.isObject(e)?e.signal?n.signalRef(e.signal):t.error("Unsupported object: "+t.stringValue(e)):e}function yt(e){t.error("Can not find data set: "+t.stringValue(e))}function bt(e,n,a){if(e)return e.signal?a.signalRef(e.signal):(t.isArray(e)?function(e,t,n){return e.map(function(e){return vt(e,n)})}:e.fields?function(e,n,a){var r=e.data,i=e.fields.reduce(function(e,n){return n=t.isString(n)?{data:r,field:n}:t.isArray(n)||n.signal?function(e,n){var a="_:vega:_"+dt++,r=Be({});if(t.isArray(e))r.value={$ingest:e};else if(e.signal){var i="setdata("+t.stringValue(a)+","+e.signal+")";r.params.input=n.signalRef(i)}return n.addDataPipeline(a,[r,ot({})]),{data:a,field:"data"}}(n,a):n,e.push(n),e},[]);return(gt(n.type)?function(e,t,n){var a,r,i;return a=n.map(function(e){var n=t.getData(e.data);return n||yt(e.data),n.countsRef(t,e.field)}),r=t.add(Le({groupby:Ee,ops:["sum"],fields:[t.fieldRef("count")],as:["count"],pulse:a})),i=t.add(Be({pulse:je(r)})),je(t.add(ut({field:Ee,sort:t.sortRef(xt(e.sort,!0)),pulse:je(i)})))}:ht(n.type)?function(e,t,n){var a=n.map(function(e){var n=t.getData(e.data);return n||yt(e.data),n.domainRef(t,e.field)});return je(t.add(Ke({values:a})))}:function(e,t,n){var a=n.map(function(e){var n=t.getData(e.data);return n||yt(e.data),n.extentRef(t,e.field)});return je(t.add(Je({extents:a})))})(e,a,i)}:function(e,t,n){var a=n.getData(e.data);a||yt(e.data);return gt(t.type)?a.valuesRef(n,e.field,xt(e.sort,!1)):ht(t.type)?a.domainRef(n,e.field):a.extentRef(n,e.field)})(e,n,a);null==n.domainMin&&null==n.domainMax||t.error("No scale domain defined for domainMin/domainMax to override.")}function xt(e,n){return e&&(e.field||e.op?e.field||"count"===e.op?n&&e.field?t.error("Multiple domain scales can not sort by field."):n&&e.op&&"count"!==e.op&&t.error("Multiple domain scales support op count only."):t.error("No field provided for sort aggregate op: "+e.op):t.isObject(e)?e.field="key":e={field:"key"}),e}function kt(e,n,a){return t.isArray(e)?e.map(function(e){return kt(e,n,a)}):t.isObject(e)?e.signal?a.signalRef(e.signal):"fit"===n?e:t.error("Unsupported parameter object: "+t.stringValue(e)):e}var St="top",Rt="left",wt="bottom",Ot="label",zt="perc",Pt="value",jt="guide-label",Dt="guide-title",$t="group-title",Et=["shape","size","fill","stroke","strokeDash","opacity"],_t={name:1,interactive:1},Vt=t.toSet(["rule"]),Ft=t.toSet(["group","image","rect"]),At=function(e,t){var n="";return Vt[t]?n:(e.x2&&(e.x?(Ft[t]&&(n+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"),n+="o.width=o.x2-o.x;"):n+="o.x=o.x2-(o.width||0);"),e.xc&&(n+="o.x=o.xc-(o.width||0)/2;"),e.y2&&(e.y?(Ft[t]&&(n+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"),n+="o.height=o.y2-o.y;"):n+="o.y=o.y2-(o.height||0);"),e.yc&&(n+="o.y=o.yc-(o.height||0)/2;"),n)},Wt=function(e,n,a,r){var i=ge(e,n);return i.$fields.forEach(function(e){r[e]=1}),t.extend(a,i.$params),i.$expr},Mt=function(e,n,a,r){return function e(n,a,r,i){var o,l,s;if(n.signal)o="datum",s=Wt(n.signal,a,r,i);else if(n.group||n.parent){for(l=Math.max(1,n.level||1),o="item";l-- >0;)o+=".mark.group";n.parent?(s=n.parent,o+=".datum"):s=n.group}else n.datum?(o="datum",s=n.datum):t.error("Invalid field reference: "+t.stringValue(n));n.signal||(t.isString(s)?(i[s]=1,s=t.splitAccessPath(s).map(t.stringValue).join("][")):s=e(s,a,r,i));return o+"["+s+"]"}(t.isObject(e)?e:{datum:e},n,a,r)};var Lt=function(e,n,a,r,i){var o,l,s,u=Ct(e.scale,a,r,i);return null!=e.range?(l=u+".range()",n=0===(o=+e.range)?l+"[0]":"($="+l+","+(1===o?"$[$.length-1]":"$[0]+"+o+"*($[$.length-1]-$[0])")+")"):(void 0!==n&&(n=u+"("+n+")"),e.band&&(s=function(e,n){if(!t.isString(e))return-1;var a=n.scaleType(e);return"band"===a||"point"===a?1:0}(e.scale,a))&&(o=(l=u+".bandwidth")+"()"+(1===(o=+e.band)?"":"*"+o),s<0&&(o="("+l+"?"+o+":0)"),n=(n?n+"+":"")+o,e.extra&&(n="(datum.extra?"+u+"(datum.extra.value):"+n+")")),null==n&&(n="0")),n};function Ct(e,n,a,r){var i;if(t.isString(e))i=D+e,a.hasOwnProperty(i)||(a[i]=n.scaleRef(e)),i=t.stringValue(i);else{for(i in n.scales)a[D+i]=n.scaleRef(i);i=t.stringValue(D)+"+"+(e.signal?"("+Wt(e.signal,n,a,r)+")":Mt(e,n,a,r))}return"_["+i+"]"}var qt=function(e,n,a,r){return t.isObject(e)?"("+Bt(null,e,n,a,r)+")":e},Bt=function(e,n,a,r,i){if(null!=n.gradient)return l=a,s=r,u=i,"this.gradient("+Ct((o=n).gradient,l,s,u)+","+t.stringValue(o.start)+","+t.stringValue(o.stop)+","+t.stringValue(o.count)+")";var o,l,s,u,d=n.signal?Wt(n.signal,a,r,i):n.color?function(e,t,n,a){function r(e,r,i,o){return"this."+e+"("+[Bt(null,r,t,n,a),Bt(null,i,t,n,a),Bt(null,o,t,n,a)].join(",")+").toString()"}return e.c?r("hcl",e.h,e.c,e.l):e.h||e.s?r("hsl",e.h,e.s,e.l):e.l||e.a?r("lab",e.l,e.a,e.b):e.r||e.g||e.b?r("rgb",e.r,e.g,e.b):null}(n.color,a,r,i):null!=n.field?Mt(n.field,a,r,i):void 0!==n.value?t.stringValue(n.value):void 0;return null!=n.scale&&(d=Lt(n,d,a,r,i)),void 0===d&&(d=null),null!=n.exponent&&(d="Math.pow("+d+","+qt(n.exponent,a,r,i)+")"),null!=n.mult&&(d+="*"+qt(n.mult,a,r,i)),null!=n.offset&&(d+="+"+qt(n.offset,a,r,i)),n.round&&(d="Math.round("+d+")"),d},Nt=function(e,n,a){return e+"["+t.stringValue(n)+"]="+a+";"},Ut=function(e,t,n,a,r){var i="";return t.forEach(function(t){var o=Bt(e,t,n,a,r);i+=t.test?Wt(t.test,n,a,r)+"?"+o+":":o}),Nt("o",e,i)};function Tt(e,n,a,r){var i,o,l,s={},u="var o=item,datum=o.datum,$;";for(i in e)o=e[i],t.isArray(o)?u+=Ut(i,o,r,a,s):(l=Bt(i,o,r,a,s),u+=Nt("o",i,l));return u+=At(e,n),{$expr:u+="return 1;",$fields:Object.keys(s),$output:Object.keys(e)}}var It="mark",Xt="frame",Ht="scope",Yt="axis-domain",Gt="axis-grid",Jt="axis-label",Kt="axis-tick",Qt="axis-title",Zt="legend-entry",en="legend-label",tn="legend-symbol",nn="legend-title",an="title";function rn(e){return t.isObject(e)?e:{value:e}}function on(e,n,a){return null!=a?(e[n]=t.isObject(a)&&!t.isArray(a)?a:{value:a},1):0}function ln(e,n,a){for(var r in n)a&&a.hasOwnProperty(r)||(e[r]=t.extend(e[r]||{},n[r]));return e}function sn(e,n,a,r,i,o){var l,s;for(s in(o=o||{}).encoders={$encode:l={}},e=function(e,n,a,r,i){var o,l,s={};"legend"!=a&&0!==String(a).indexOf("axis")||(a=null);for(o in l=a===Xt?i.group:a===It?t.extend({},i.mark,i[n]):null)un(o,e)||("fill"===o||"stroke"===o)&&(un("fill",e)||un("stroke",e))||(s[o]={value:l[o]});return t.array(r).forEach(function(t){var n=i.style&&i.style[t];for(var a in n)un(a,e)||(s[a]={value:n[a]})}),(e=t.extend({},e)).enter=t.extend(s,e.enter),e}(e,n,a,r,i.config))l[s]=Tt(e[s],n,o,i);return o}function un(e,t){return t&&(t.enter&&t.enter[e]||t.update&&t.update[e])}var dn=function(e,t,n,a,r,i,o){return{type:e,name:o?o.name:void 0,role:t,style:o&&o.style||n,key:a,from:r,interactive:!(!o||!o.interactive),encode:ln(i,o,_t)}},fn="group",cn="rule",pn="text",gn=function(e,t,n,a,r,i,o){return{type:fn,name:n,role:e,style:t,from:a,interactive:r||!1,encode:i,marks:o}};function hn(e){return t.isObject(e)&&e.signal?e.signal:t.stringValue(e)}var mn=function(e){var t=e.role||"";return t.indexOf("axis")&&t.indexOf("legend")?e.type===fn?Ht:t||It:t},vn=function(e,a){var r=n.definition(e.type);r||t.error("Unrecognized transform type: "+t.stringValue(e.type));var i=ze(r.type.toLowerCase(),null,yn(r,e,a));return e.signal&&a.addSignal(e.signal,a.proxy(i)),i.metadata=r.metadata||{},i};function yn(e,t,n){var a,r,i,o={};for(r=0,i=e.params.length;r<i;++r)o[(a=e.params[r]).name]=bn(a,t,n);return o}function bn(e,n,a){var r,i,o,l=e.type,s=n[e.name];if("index"===l)return function(e,n,a){t.isString(n.from)||t.error('Lookup "from" parameter must be a string literal.');return a.getData(n.from).lookupRef(a,n.key)}(0,n,a);{if(void 0!==s)return"param"===l?(i=a,o=n[(r=e).name],r.array?(t.isArray(o)||t.error("Expected an array of sub-parameters. Instead: "+t.stringValue(o)),o.map(function(e){return kn(r,e,i)})):kn(r,o,i)):"projection"===l?a.projectionRef(n[e.name]):e.array&&!Ae(s)?s.map(function(t){return xn(e,t,a)}):xn(e,s,a);e.required&&t.error("Missing required "+t.stringValue(n.type)+" parameter: "+t.stringValue(e.name))}}function xn(e,n,a){var r=e.type;if(Ae(n))return Sn(r)?t.error("Expression references can not be signals."):Rn(r)?a.fieldRef(n):wn(r)?a.compareRef(n):a.signalRef(n.signal);var i,o,l=e.expr||Rn(r);return l&&((o=n)&&o.expr)?ge(n.expr,a):l&&((i=n)&&i.field)?$e(n.field):Sn(r)?ge(n,a):"data"===r?je(a.getData(n).values):Rn(r)?$e(n):wn(r)?a.compareRef(n):n}function kn(e,n,a){var r,i,o,l,s;for(l=0,s=e.params.length;l<s;++l){for(o in(i=e.params[l]).key)if(i.key[o]!==n[o]){i=null;break}if(i)break}return i||t.error("Unsupported parameter: "+t.stringValue(n)),r=t.extend(yn(i,n,a),i.key),je(a.add(Ze(r)))}function Sn(e){return"expr"===e}function Rn(e){return"field"===e}function wn(e){return"compare"===e}function On(e,t,n,a,r){this.scope=e,this.input=t,this.output=n,this.values=a,this.aggregate=r,this.index={}}On.fromEntries=function(e,t){var n=t.length,a=1,r=t[0],i=t[n-1],o=t[n-2],l=null;for(e.add(t[0]);a<n;++a)t[a].params.pulse=je(t[a-1]),e.add(t[a]),"aggregate"===t[a].type&&(l=t[a]);return new On(e,r,o,i,l)};var zn=On.prototype;function Pn(e){return t.isString(e)?e:null}function jn(e,t,n){var a,r=Fe(n.op,n.field);if(t.ops){for(var i=0,o=t.as.length;i<o;++i)if(t.as[i]===r)return}else t.ops=["count"],t.fields=[null],t.as=["count"];n.op&&(t.ops.push((a=n.op.signal)?e.signalRef(a):n.op),t.fields.push(e.fieldRef(n.field)),t.as.push(r))}function Dn(e,n,a,r,i,o,l){var s,u,d,f=n[a]||(n[a]={}),c=(d=o,t.isObject(d)?(d.order===Ve?"-":"+")+Fe(d.op,d.field):""),p=Pn(i);if(null!=p&&(e=n.scope,s=f[p+=c?"|"+c:""]),!s){var g=o?{field:Ee,pulse:n.countsRef(e,i,o)}:{field:e.fieldRef(i),pulse:je(n.output)};c&&(g.sort=e.sortRef(o)),u=e.add(ze(r,void 0,g)),l&&(n.index[i]=u),s=je(u),null!=p&&(f[p]=s)}return s}zn.countsRef=function(e,t,n){var a,r,i,o=this.counts||(this.counts={}),l=Pn(t);return null!=l&&(e=this.scope,a=o[l]),a?n&&n.field&&jn(e,a.agg.params,n):(i={groupby:e.fieldRef(t,"key"),pulse:je(this.output)},n&&n.field&&jn(e,i,n),a={agg:r=e.add(Le(i)),ref:je(a=e.add(Be({pulse:je(r)})))},null!=l&&(o[l]=a)),a.ref},zn.tuplesRef=function(){return je(this.values)},zn.extentRef=function(e,t){return Dn(e,this,"extent","extent",t,!1)},zn.domainRef=function(e,t){return Dn(e,this,"domain","values",t,!1)},zn.valuesRef=function(e,t,n){return Dn(e,this,"vals","values",t,n||!0)},zn.lookupRef=function(e,t){return Dn(e,this,"lookup","tupleindex",t,!1)},zn.indataRef=function(e,t){return Dn(e,this,"indata","tupleindex",t,!0,!0)};var $n=function(e,t,n){var a,r,i=e.remove,o=e.insert,l=e.toggle,s=e.modify,u=e.values,d=t.add(Pe());a="if("+e.trigger+',modify("'+n+'",'+[o,i,l,s,u].map(function(e){return null==e?"null":e}).join(",")+"),0)",r=ge(a,t),d.update=r.$expr,d.params=r.$params},En=function(e,n){var a,r,i,o,l,s,u,d,f,c,p,g,h,m,v,y,b,x,k,S,R,w,O,z,P,j,D,$,E,_,V,F,A,W,M,L,C,q,B,N,U,T,I=mn(e),X=e.type===fn,H=e.from&&e.from.facet,Y=e.layout||I===Ht||I===Xt,G=I===It||Y||H,J=e.overlap;m=e.from,v=X,y=n,m?(b=m.facet)&&(v||t.error("Only group marks can be faceted."),null!=b.field?S=R=je(y.getData(b.data).output):(m.data?R=je(y.getData(m.data).aggregate):((k=vn(t.extend({type:"aggregate",groupby:t.array(b.groupby)},b.aggregate),y)).params.key=y.keyRef(b.groupby),k.params.pulse=je(y.getData(b.data).output),S=R=je(y.add(k))),x=y.keyRef(b.groupby,!0))):S=je(y.add(Be(null,[{}]))),S||(S=m.$ref?m:je(y.getData(m.data).output)),i={key:x,pulse:S,parent:R},f=je(r=n.add(Ue({key:i.key||(e.key?$e(e.key):void 0),pulse:i.pulse,clean:!X}))),r=o=n.add(Be({pulse:f})),c=je(r=n.add(Ge({markdef:(D=e,{marktype:D.type,name:D.name||void 0,role:D.role||mn(D),zindex:+D.zindex||void 0}),interactive:(P=e.interactive,j=n,P&&P.signal?j.signalRef(P.signal):!1!==P),clip:(w=e.clip,O=n,t.isObject(w)&&(w.signal?z=w.signal:w.path?z="pathShape("+hn(w.path)+")":w.sphere&&(z="geoShape("+hn(w.sphere)+', {type: "Sphere"})')),z?O.signalRef(z):!!w),context:{$context:!0},groups:n.lookup(),parent:n.signals.parent?n.signalRef("parent"):null,index:n.markpath(),pulse:je(r)}))),(r=n.add(Te(sn(e.encode,e.type,I,e.style,n,{pulse:c})))).params.parent=n.encode(),e.transform&&e.transform.forEach(function(e){var a=vn(e,n);(a.metadata.generates||a.metadata.changes)&&t.error("Mark transforms should not generate new data."),a.params.pulse=je(r),n.add(r=a)}),e.sort&&(r=n.add(lt({sort:n.compareRef(e.sort,!0),pulse:je(r)}))),p=je(r),(H||Y)&&(g=je(Y=n.add(st({layout:n.objectProperty(e.layout),legendMargin:n.config.legendMargin,mark:c,pulse:p})))),h=je(l=n.add(qe({mark:c,pulse:g||p}))),X&&(G&&((a=n.operators).pop(),Y&&a.pop()),n.pushState(p,g||h,f),H?(W=n,M=i,N=(A=e).from.facet,U=N.name,T=je(W.getData(N.data).output),N.name||t.error("Facet must have a name: "+t.stringValue(N)),N.data||t.error("Facet must reference a data set: "+t.stringValue(N)),N.field?B=W.add(et({field:W.fieldRef(N.field),pulse:T})):N.groupby?B=W.add(Ie({key:W.keyRef(N.groupby),group:je(W.proxy(M.parent)),pulse:T})):t.error("Facet must specify groupby or field: "+t.stringValue(N)),C=(L=W.fork()).add(Be()),q=L.add(ot({pulse:je(C)})),L.addData(U,new On(L,C,C,q)),L.addSignal("parent",null),B.params.subflow={$subflow:qn(A,L).toRuntime()}):G?($=e,_=i,V=(E=n).add(et({pulse:_.pulse})),(F=E.fork()).add(ot()),F.addSignal("parent",null),V.params.subflow={$subflow:qn($,F).toRuntime()}):qn(e,n),n.popState(),G&&(Y&&a.push(Y),a.push(l))),J&&(r={method:!0===J.method?"parity":J.method,pulse:h},J.order&&(r.sort=n.compareRef({field:J.order})),J.bound&&(r.boundScale=n.scaleRef(J.bound.scale),r.boundOrient=J.bound.orient,r.boundTolerance=J.bound.tolerance),h=je(n.add(Qe(r)))),s=n.add(rt({pulse:h})),u=n.add(ot({pulse:je(s)},void 0,n.parent())),null!=e.name&&(d=e.name,n.addData(d,new On(n,o,s,u)),e.on&&e.on.forEach(function(e){(e.insert||e.remove||e.toggle)&&t.error("Marks only support modify triggers."),$n(e,n,d)}))},_n=function(e,n){var a,r,i,o,l,s,u,d,f,c,p,g,h,m,v,y,b,x,k,S,R,w,O,z,P,j,D,$,E,_,V,F,A,W,M,L,C,q,B,N,U,T,I,X,H,Y,G,J=e.type||"symbol",K=n.config.legend,Q=e.encode||{},Z=Q.legend||{},ee=Z.name||void 0,te=Z.interactive,ne=Z.style,ae=e.size||e.shape||e.fill||e.stroke||e.strokeDash||e.opacity;return ae||t.error("Missing valid scale for legend."),a={orient:We(e.orient,K.orient),title:null!=e.title},r=je(n.add(Be(null,[a]))),Z=ln({enter:(f=K,c={},on(c,"fill",f.fillColor)+on(c,"stroke",f.strokeColor)+on(c,"strokeWidth",f.strokeWidth)+on(c,"strokeDash",f.strokeDash)+on(c,"cornerRadius",f.cornerRadius)?c:void 0),update:{offset:rn(We(e.offset,K.offset)),padding:rn(We(e.padding,K.padding)),titlePadding:rn(We(e.titlePadding,K.titlePadding))}},Z,_t),s={update:{x:{field:{group:"padding"}},y:{field:{group:"padding"}},entryPadding:rn(We(e.entryPadding,K.entryPadding))}},"gradient"===J?(i=je(n.add(Ye({type:"gradient",scale:n.scaleRef(ae),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),d=[(A=ae,W=K,M=Q.gradient,q={value:0},B={},B.enter=L={opacity:q,x:q,y:q},on(L,"width",W.gradientWidth),on(L,"height",W.gradientHeight),on(L,"stroke",W.gradientStrokeColor),on(L,"strokeWidth",W.gradientStrokeWidth),B.exit={opacity:q},B.update=C={x:q,y:q,fill:{gradient:A},opacity:{value:1}},on(C,"width",W.gradientWidth),on(C,"height",W.gradientHeight),dn("rect","legend-gradient",null,void 0,void 0,B,M)),(j=K,D=Q.labels,$=i,V={value:0},F={},F.enter=E={opacity:V},on(E,"fill",j.labelColor),on(E,"font",j.labelFont),on(E,"fontSize",j.labelFontSize),on(E,"fontWeight",j.labelFontWeight),on(E,"baseline",j.gradientLabelBaseline),on(E,"limit",j.gradientLabelLimit),F.exit={opacity:V},F.update=_={opacity:{value:1},text:{field:Ot}},E.x=_.x={field:zt,mult:j.gradientWidth},E.y=_.y={value:j.gradientHeight,offset:j.gradientLabelOffset},E.align=_.align={signal:'datum.perc<=0?"left":datum.perc>=1?"right":"center"'},dn(pn,en,jt,zt,$,F,D))]):(i=je(n.add(Ye(u={scale:n.scaleRef(ae),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),d=[(x=e,k=K,S=Q.symbols,R=i,z={value:0},P={},P.enter=w={opacity:z},on(w,"shape",k.symbolType),on(w,"size",k.symbolSize),on(w,"strokeWidth",k.symbolStrokeWidth),x.fill||(on(w,"fill",k.symbolFillColor),on(w,"stroke",k.symbolStrokeColor)),P.exit={opacity:z},P.update=O={opacity:{value:1}},w.x=O.x={field:"offset",mult:.5},w.y=O.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},Et.forEach(function(e){x[e]&&(O[e]=w[e]={scale:x[e],field:Pt})}),dn("symbol",tn,null,Pt,R,P,S)),(p=K,g=Q.labels,h=i,y={value:0},b={},b.enter=m={opacity:y},on(m,"align",p.labelAlign),on(m,"baseline",p.labelBaseline),on(m,"fill",p.labelColor),on(m,"font",p.labelFont),on(m,"fontSize",p.labelFontSize),on(m,"fontWeight",p.labelFontWeight),on(m,"limit",p.labelLimit),b.exit={opacity:y},b.update=v={opacity:{value:1},text:{field:Ot}},m.x=v.x={field:"offset",offset:p.labelOffset},m.y=v.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},dn(pn,en,jt,Pt,h,b,g))],u.size=function(e,t,n){var a=Vn(t,n[1].encode,"fontSize",jt);{if(e.size)return{$expr:"Math.max(Math.ceil(Math.sqrt(_.scale(datum))),"+a+")"};var r=Vn(t,n[0].encode,"size");return Math.max(Math.ceil(Math.sqrt(r)),a)}}(e,n,d)),d=[gn(Zt,null,null,r,te,s,d)],a.title&&(N=e,U=K,T=Q.title,I=r,H={value:0},Y=N.title,(G={}).enter=X={x:{field:{group:"padding"}},y:{field:{group:"padding"}},opacity:H},on(X,"align",U.titleAlign),on(X,"baseline",U.titleBaseline),on(X,"fill",U.titleColor),on(X,"font",U.titleFont),on(X,"fontSize",U.titleFontSize),on(X,"fontWeight",U.titleFontWeight),on(X,"limit",U.titleLimit),G.exit={opacity:H},G.update={opacity:{value:1},text:Y&&Y.signal?{signal:Y.signal}:{value:Y+""}},l=dn(pn,nn,Dt,null,I,G,T),s.update.y.offset={field:{group:"titlePadding"},offset:Vn(n,l.encode,"fontSize",Dt)},d.push(l)),o=gn("legend",ne,ee,r,te,Z,d),e.zindex&&(o.zindex=e.zindex),En(o,n)};function Vn(e,t,n,a){var r=t&&(t.update&&t.update[n]||t.enter&&t.enter[n]);return+(r?r.value:a&&(r=e.config.style[a])&&r[n])}var Fn=function(e,n){e=t.isString(e)?{text:e}:e;var a,r,i,o=n.config.title,l=t.extend({},e.encode);return a={orient:null!=e.orient?e.orient:o.orient},r=je(n.add(Be(null,[a]))),l.name=e.name,l.interactive=e.interactive,i=function(e,n,a,r){var i,o,l,s,u,d,f=e.text,c=e.orient||n.orient,p=e.anchor||n.anchor,g=c===Rt||c===St?-1:1,h=c===St||c===wt,m={group:h?"width":"height"},v={};v.enter=i={opacity:{value:0}},on(i,"fill",n.color),on(i,"font",n.font),on(i,"fontSize",n.fontSize),on(i,"fontWeight",n.fontWeight),v.exit={opacity:{value:0}},v.update=o={opacity:{value:1},text:t.isObject(f)?f:{value:f+""},offset:rn((null!=e.offset?e.offset:n.offset)||0)},"start"===p?(u=0,d="left"):"end"===p?(u=1,d="right"):(u=.5,d="center");l={field:m,mult:u},s=g<0?{value:0}:h?{field:{group:"height"}}:{field:{group:"width"}},h?(o.x=l,o.y=s,o.angle={value:0},o.baseline={value:c===St?"bottom":"top"}):(o.x=s,o.y=l,o.angle={value:90*g},o.baseline={value:"bottom"});return o.align={value:d},o.limit={field:m},on(o,"angle",n.angle),on(o,"baseline",n.baseline),on(o,"limit",n.limit),dn(pn,an,e.style||$t,null,r,v,a)}(e,o,l,r),e.zindex&&(i.zindex=e.zindex),En(i,n)};function An(e,n){var a=[];e.transform&&e.transform.forEach(function(e){a.push(vn(e,n))}),e.on&&e.on.forEach(function(t){$n(t,n,e.name)}),n.addDataPipeline(e.name,function(e,n,a){var r,i,o,l,s,u=[],d=null,f=!1,c=!1;e.values?u.push(d=Wn({$ingest:e.values,$format:e.format})):e.url?u.push(d=Wn({$request:e.url,$format:e.format})):e.source&&(d=r=t.array(e.source).map(function(e){return je(n.getData(e).output)}),u.push(null));for(i=0,o=a.length;i<o;++i)l=a[i],s=l.metadata,d||s.source||u.push(d=Wn()),u.push(l),s.generates&&(c=!0),s.modifies&&!c&&(f=!0),s.source?d=l:s.changes&&(d=null);r&&(o=r.length-1,u[0]=at({derive:f,pulse:o?r:r[0]}),(f||o)&&u.splice(1,0,Wn()));d||u.push(Wn());return u.push(ot({})),u}(e,n,a))}function Wn(e){var t=Be({},e);return t.metadata={source:!0},t}function Mn(e,t){return{scale:e.scale,range:t}}function Ln(e,t,n,a,r){return{signal:'flush(range("'+e+'"), scale("'+e+'", datum.value), '+t+","+n+","+a+","+r+")"}}var Cn=function(e,n){var a,r,i,o,l,s,u,d,f,c,p,g,h,m,v,y,b,x,k,S,R,w,O,z,P,j,D,$,E,_,V,F,A,W,M,L,C,q,B,N,U,T,I,X,H,Y,G,J,K,Q,Z,ee,te,ne,ae,re,ie,oe,le,se,ue,de,fe,ce,pe,ge,he,me,ve,ye,be,xe,ke,Se,Re,we,Oe,ze,Pe,De,$e,Ee,_e,Ve,Fe,Ae,Me,Le,qe,Ne,Ue=(u=e,f=(d=n).config,c=u.orient,p=c===St||c===wt?f.axisX:f.axisY,g=f["axis"+c[0].toUpperCase()+c.slice(1)],h="band"===d.scaleType(u.scale)&&f.axisBand,p||g||h?t.extend({},f.axis,p,g,h):f.axis),Te=e.encode||{},Ie=Te.axis||{},Xe=Ie.name||void 0,He=Ie.interactive,Ye=Ie.style;return a={orient:e.orient,ticks:!!We(e.ticks,Ue.ticks),labels:!!We(e.labels,Ue.labels),grid:!!We(e.grid,Ue.grid),domain:!!We(e.domain,Ue.domain),title:!!We(e.title,!1)},r=je(n.add(Be({},[a]))),Ie=ln({update:{range:{signal:'abs(span(range("'+e.scale+'")))'},offset:rn(We(e.offset,0)),position:rn(We(e.position,0)),titlePadding:rn(We(e.titlePadding,Ue.titlePadding)),minExtent:rn(We(e.minExtent,Ue.minExtent)),maxExtent:rn(We(e.maxExtent,Ue.maxExtent))}},Te.axis,_t),i=je(n.add(Ce({scale:n.scaleRef(e.scale),extra:Ue.tickExtra,count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),s=[],a.grid&&s.push((m=e,v=Ue,y=Te.grid,b=i,j=m.orient,D=m.gridScale,E=($=j===Rt||j===St?1:-1)*m.offset||0,(V={}).enter=x={opacity:_={value:0}},on(x,"stroke",v.gridColor),on(x,"strokeWidth",v.gridWidth),on(x,"strokeDash",v.gridDash),V.exit=k={opacity:_},V.update=S={},on(S,"opacity",v.gridOpacity),R={scale:m.scale,field:Pt,band:v.bandPosition,round:v.tickRound,extra:v.tickExtra,offset:v.tickOffset},j===St||j===wt?(w="x",O="y",P="height"):(w="y",O="x",P="width"),z=O+"2",S[w]=x[w]=k[w]=R,D?(x[O]={scale:D,range:0,mult:$,offset:E},S[z]=x[z]={scale:D,range:1,mult:$,offset:E}):(x[O]={value:E},S[z]=x[z]={signal:P,mult:$,offset:E}),dn(cn,Gt,null,Pt,b,V,y))),a.ticks&&(o=We(e.tickSize,Ue.tickSize),s.push((F=e,A=Ue,W=Te.ticks,M=i,L=o,T=F.orient,I=T===Rt||T===St?-1:1,(H={}).enter=C={opacity:X={value:0}},on(C,"stroke",A.tickColor),on(C,"strokeWidth",A.tickWidth),H.exit=q={opacity:X},H.update=B={opacity:{value:1}},(N=rn(L)).mult=I,U={scale:F.scale,field:Pt,band:A.bandPosition,round:A.tickRound,extra:A.tickExtra,offset:A.tickOffset},T===St||T===wt?(B.y=C.y=X,B.y2=C.y2=N,B.x=C.x=q.x=U):(B.x=C.x=X,B.x2=C.x2=N,B.y=C.y=q.y=U),dn(cn,Kt,null,Pt,M,H,W)))),a.labels&&(o=a.ticks?o:0,s.push((Y=e,G=Ue,J=Te.labels,K=i,Q=o,re=Y.orient,ie=re===Rt||re===St?-1:1,oe=Y.scale,le=We(Y.labelPadding,G.labelPadding),se=We(Y.labelBound,G.labelBound),ue=We(Y.labelFlush,G.labelFlush),de=null!=ue&&!1!==ue&&(ue=+ue)===ue,fe=+We(Y.labelFlushOffset,G.labelFlushOffset),ce=We(Y.labelOverlap,G.labelOverlap),(ge={}).enter=Z={opacity:pe={value:0}},on(Z,"angle",G.labelAngle),on(Z,"fill",G.labelColor),on(Z,"font",G.labelFont),on(Z,"fontSize",G.labelFontSize),on(Z,"fontWeight",G.labelFontWeight),on(Z,"limit",G.labelLimit),ge.exit=ee={opacity:pe},ge.update=te={opacity:{value:1},text:{field:Ot}},(ne=rn(Q)).mult=ie,ne.offset=rn(le),ne.offset.mult=ie,ae={scale:oe,field:Pt,band:.5,offset:G.tickOffset},re===St||re===wt?(te.y=Z.y=ne,te.x=Z.x=ee.x=ae,on(te,"align",de?Ln(oe,ue,'"left"','"right"','"center"'):"center"),de&&fe&&on(te,"dx",Ln(oe,ue,-fe,fe,0)),on(te,"baseline",re===St?"bottom":"top")):(te.x=Z.x=ne,te.y=Z.y=ee.y=ae,on(te,"align","right"===re?"left":"right"),on(te,"baseline",de?Ln(oe,ue,'"bottom"','"top"','"middle"'):"middle"),de&&fe&&on(te,"dy",Ln(oe,ue,fe,-fe,0))),Y=dn(pn,Jt,jt,Pt,K,ge,J),(ce||se)&&(Y.overlap={method:ce,order:"datum.index",bound:se?{scale:oe,orient:re,tolerance:+se}:null}),Y))),a.domain&&s.push((he=e,me=Ue,ve=Te.domain,ye=r,we=he.orient,(ze={}).enter=be={opacity:Oe={value:0}},on(be,"stroke",me.domainColor),on(be,"strokeWidth",me.domainWidth),ze.exit={opacity:Oe},ze.update=xe={opacity:{value:1}},we===St||we===wt?(ke="x",Re="y"):(ke="y",Re="x"),Se=ke+"2",be[Re]=Oe,xe[ke]=be[ke]=Mn(he,0),xe[Se]=be[Se]=Mn(he,1),dn(cn,Yt,null,null,ye,ze,ve))),a.title&&s.push((Pe=e,De=Ue,$e=Te.title,Ee=r,Ae=Pe.orient,Me=Pe.title,Le=Ae===Rt||Ae===St?-1:1,qe=Ae===St||Ae===wt,(Ne={}).enter=_e={opacity:{value:0}},on(_e,"align",De.titleAlign),on(_e,"fill",De.titleColor),on(_e,"font",De.titleFont),on(_e,"fontSize",De.titleFontSize),on(_e,"fontWeight",De.titleFontWeight),on(_e,"limit",De.titleLimit),Ne.exit={opacity:{value:0}},Ne.update=Ve={opacity:{value:1},text:Me&&Me.signal?{signal:Me.signal}:{value:Me+""}},Fe={scale:Pe.scale,range:.5},qe?(Ve.x=Fe,Ve.angle={value:0},Ve.baseline={value:Ae===St?"bottom":"top"}):(Ve.y=Fe,Ve.angle={value:90*Le},Ve.baseline={value:"bottom"}),on(Ve,"angle",De.titleAngle),on(Ve,"baseline",De.titleBaseline),!on(Ve,"x",De.titleX)&&qe&&!un("x",$e)&&(Ne.enter.auto={value:!0}),!on(Ve,"y",De.titleY)&&!qe&&!un("y",$e)&&(Ne.enter.auto={value:!0}),dn(pn,Qt,Dt,null,Ee,Ne,$e))),l=gn("axis",Ye,Xe,r,He,Ie,s),e.zindex&&(l.zindex=e.zindex),En(l,n)},qn=function(e,n,a){var r=t.array(e.signals),i=t.array(e.scales);return a||r.forEach(function(e){y(e,n)}),t.array(e.projections).forEach(function(e){!function(e,t){var n={};for(var a in e)"name"!==a&&(n[a]=kt(e[a],a,t));t.addProjection(e.name,n)}(e,n)}),i.forEach(function(e){var a,r,i;r=n,i=(a=e).type||"linear",ct.hasOwnProperty(i)||t.error("Unrecognized scale type: "+t.stringValue(i)),r.addScale(a.name,{type:i,domain:void 0})}),t.array(e.data).forEach(function(e){An(e,n)}),i.forEach(function(e){mt(e,n)}),r.forEach(function(e){we(e,n)}),t.array(e.axes).forEach(function(e){Cn(e,n)}),t.array(e.marks).forEach(function(e){En(e,n)}),t.array(e.legends).forEach(function(e){_n(e,n)}),e.title&&Fn(e.title,n),n.parseLambdas(),n},Bn=t.toSet(["width","height","padding","autosize"]);function Nn(e){this.config=e,this.bindings=[],this.field={},this.signals={},this.lambdas={},this.scales={},this.events={},this.data={},this.streams=[],this.updates=[],this.operators=[],this.background=null,this.eventConfig=null,this._id=0,this._subid=0,this._nextsub=[0],this._parent=[],this._encode=[],this._lookup=[],this._markpath=[]}function Un(e){this.config=e.config,this.field=Object.create(e.field),this.signals=Object.create(e.signals),this.lambdas=Object.create(e.lambdas),this.scales=Object.create(e.scales),this.events=Object.create(e.events),this.data=Object.create(e.data),this.streams=[],this.updates=[],this.operators=[],this._id=0,this._subid=++e._nextsub[0],this._nextsub=e._nextsub,this._parent=e._parent.slice(),this._encode=e._encode.slice(),this._lookup=e._lookup.slice(),this._markpath=e._markpath}var Tn=Nn.prototype=Un.prototype;function In(e){return(t.isArray(e)?function(e){for(var n,a="[",r=0,i=e.length;r<i;++r)n=e[r],a+=(r>0?",":"")+(t.isObject(n)?n.signal||In(n):t.stringValue(n));return a+"]"}:function(e){var n,a,r="{",i=0;for(n in e)a=e[n],r+=(++i>1?",":"")+t.stringValue(n)+":"+(t.isObject(a)?a.signal||In(a):t.stringValue(a));return r+"}"})(e)}Tn.fork=function(){return new Un(this)},Tn.toRuntime=function(){return this.finish(),{background:this.background,operators:this.operators,streams:this.streams,updates:this.updates,bindings:this.bindings,eventConfig:this.eventConfig}},Tn.id=function(){return(this._subid?this._subid+":":0)+this._id++},Tn.add=function(e){return this.operators.push(e),e.id=this.id(),e.refs&&(e.refs.forEach(function(t){t.$ref=e.id}),e.refs=null),e},Tn.proxy=function(e){var t=e instanceof Oe?je(e):e;return this.add(nt({value:t}))},Tn.addStream=function(e){return this.streams.push(e),e.id=this.id(),e},Tn.addUpdate=function(e){return this.updates.push(e),e},Tn.finish=function(){var e,t;for(e in this.root&&(this.root.root=!0),this.signals)this.signals[e].signal=e;for(e in this.scales)this.scales[e].scale=e;function n(e,t,n){var a;e&&((a=e.data||(e.data={}))[t]||(a[t]=[])).push(n)}for(e in this.data)for(var a in n((t=this.data[e]).input,e,"input"),n(t.output,e,"output"),n(t.values,e,"values"),t.index)n(t.index[a],e,"index:"+a);return this},Tn.pushState=function(e,t,n){this._encode.push(je(this.add(ot({pulse:e})))),this._parent.push(t),this._lookup.push(n?je(this.proxy(n)):null),this._markpath.push(-1)},Tn.popState=function(){this._encode.pop(),this._parent.pop(),this._lookup.pop(),this._markpath.pop()},Tn.parent=function(){return t.peek(this._parent)},Tn.encode=function(){return t.peek(this._encode)},Tn.lookup=function(){return t.peek(this._lookup)},Tn.markpath=function(){var e=this._markpath;return++e[e.length-1]},Tn.fieldRef=function(e,n){if(t.isString(e))return $e(e,n);e.signal||t.error("Unsupported field reference: "+t.stringValue(e));var a,r=e.signal,i=this.field[r];return i||(a={name:this.signalRef(r)},n&&(a.as=n),this.field[r]=i=je(this.add(Xe(a)))),i},Tn.compareRef=function(e,n){function a(e){return Ae(e)?(i=!0,je(r[e.signal])):e}var r=this.signals,i=!1,o=t.array(e.field).map(a),l=t.array(e.order).map(a);return n&&o.push(De),i?je(this.add(Ne({fields:o,orders:l}))):_e(o,l)},Tn.keyRef=function(e,n){var a,r=this.signals,i=!1;return e=t.array(e).map(function(e){return Ae(e)?(i=!0,je(r[e.signal])):e}),i?je(this.add(He({fields:e,flat:n}))):(a={$key:e},n&&(a.$flat=!0),a)},Tn.sortRef=function(e){if(!e)return e;var t=[Fe(e.op,e.field),De],n=e.order||"ascending";return n.signal?je(this.add(Ne({fields:t,orders:[n=this.signalRef(n.signal),n]}))):_e(t,[n,n])},Tn.event=function(e,t){var n=e+":"+t;if(!this.events[n]){var a=this.id();this.streams.push({id:a,source:e,type:t}),this.events[n]=a}return this.events[n]},Tn.addSignal=function(e,n){this.signals.hasOwnProperty(e)&&t.error("Duplicate signal name: "+t.stringValue(e));var a=n instanceof Oe?n:this.add(Pe(n));return this.signals[e]=a},Tn.getSignal=function(e){return this.signals[e]||t.error("Unrecognized signal name: "+t.stringValue(e)),this.signals[e]},Tn.signalRef=function(e){return this.signals[e]?je(this.signals[e]):(this.lambdas.hasOwnProperty(e)||(this.lambdas[e]=this.add(Pe(null))),je(this.lambdas[e]))},Tn.parseLambdas=function(){for(var e=Object.keys(this.lambdas),t=0,n=e.length;t<n;++t){var a=e[t],r=ge(a,this),i=this.lambdas[a];i.params=r.$params,i.update=r.$expr}},Tn.property=function(e){return e&&e.signal?this.signalRef(e.signal):e},Tn.objectProperty=function(e){return e&&t.isObject(e)?this.signalRef(e.signal||In(e)):e},Tn.addBinding=function(e,n){this.bindings||t.error("Nested signals do not support binding: "+t.stringValue(e)),this.bindings.push(t.extend({signal:e},n))},Tn.addScaleProj=function(e,n){this.scales.hasOwnProperty(e)&&t.error("Duplicate scale or projection name: "+t.stringValue(e)),this.scales[e]=this.add(n)},Tn.addScale=function(e,t){this.addScaleProj(e,it(t))},Tn.addProjection=function(e,t){this.addScaleProj(e,tt(t))},Tn.getScale=function(e){return this.scales[e]||t.error("Unrecognized scale name: "+t.stringValue(e)),this.scales[e]},Tn.projectionRef=Tn.scaleRef=function(e){return je(this.getScale(e))},Tn.projectionType=Tn.scaleType=function(e){return this.getScale(e).params.type},Tn.addData=function(e,n){return this.data.hasOwnProperty(e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.data[e]=n},Tn.getData=function(e){return this.data[e]||t.error("Undefined data set name: "+t.stringValue(e)),this.data[e]},Tn.addDataPipeline=function(e,n){return this.data.hasOwnProperty(e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.addData(e,On.fromEntries(this,n))};var Xn=function(e){var n={padding:0,autosize:"pad",background:null,events:{defaults:{allow:["wheel"]}},group:null,mark:null,arc:{fill:Jn},area:{fill:Jn},image:null,line:{stroke:Jn,strokeWidth:Gn},path:{stroke:Jn},rect:{fill:Jn},rule:{stroke:Kn},shape:{stroke:Jn},symbol:{fill:Jn,size:64},text:{fill:Kn,font:Hn,fontSize:11},style:{"guide-label":{fill:Kn,font:Hn,fontSize:10},"guide-title":{fill:Kn,font:Hn,fontSize:11,fontWeight:"bold"},"group-title":{fill:Kn,font:Hn,fontSize:13,fontWeight:"bold"},point:{size:Yn,strokeWidth:Gn,shape:"circle"},circle:{size:Yn,strokeWidth:Gn},square:{size:Yn,strokeWidth:Gn,shape:"square"},cell:{fill:"transparent",stroke:Zn}},axis:{minExtent:0,maxExtent:200,bandPosition:.5,domain:!0,domainWidth:1,domainColor:Qn,grid:!1,gridWidth:1,gridColor:Zn,gridOpacity:1,labels:!0,labelAngle:0,labelLimit:180,labelPadding:2,ticks:!0,tickColor:Qn,tickOffset:0,tickRound:!0,tickSize:5,tickWidth:1,titleAlign:"center",titlePadding:4},axisBand:{tickOffset:-1},legend:{orient:"right",offset:18,padding:0,entryPadding:5,titlePadding:5,gradientWidth:100,gradientHeight:20,gradientStrokeColor:Zn,gradientStrokeWidth:0,gradientLabelBaseline:"top",gradientLabelOffset:2,labelAlign:"left",labelBaseline:"middle",labelOffset:8,labelLimit:160,symbolType:"circle",symbolSize:100,symbolFillColor:"transparent",symbolStrokeColor:Qn,symbolStrokeWidth:1.5,titleAlign:"left",titleBaseline:"top",titleLimit:180},title:{orient:"top",anchor:"middle",offset:4},range:{category:{scheme:"tableau10"},ordinal:{scheme:"blues",extent:[.2,1]},heatmap:{scheme:"viridis"},ramp:{scheme:"blues",extent:[.2,1]},diverging:{scheme:"blueorange"},symbol:["circle","square","triangle-up","cross","diamond","triangle-right","triangle-down","triangle-left"]}};return(e||[]).forEach(function(e){var a,r,i;if(e)for(a in e)if("style"===a)for(a in i=n.style||(n.style={}),e.style)i[a]=t.extend(i[a]||{},e.style[a]);else r=e[a],n[a]=t.isObject(r)&&!t.isArray(r)?t.extend(t.isObject(n[a])?n[a]:{},r):r}),n},Hn="sans-serif",Yn=30,Gn=2,Jn="#4c78a8",Kn="#000",Qn="#888",Zn="#ddd";e.parse=function(e,n){return t.isObject(e)||t.error("Input Vega specification must be an object."),(a=e,r=new Nn(Xn([n,e.config])),d=r.config,r.background=a.background||d.background,r.eventConfig=d.events,u=je(r.root=r.add(Pe())),r.addSignal("width",a.width||0),r.addSignal("height",a.height||0),r.addSignal("padding",g(a.padding,d)),r.addSignal("autosize",p(a.autosize,d)),t.array(a.signals).forEach(function(e){Bn[e.name]||y(e,r)}),o=r.add(Be()),l=ln({enter:{x:{value:0},y:{value:0}},update:{width:{signal:"width"},height:{signal:"height"}}},a.encode),l=r.add(Te(sn(l,fn,Xt,a.style,r,{pulse:je(o)}))),s=r.add(st({layout:r.objectProperty(a.layout),legendMargin:d.legendMargin,autosize:r.signalRef("autosize"),mark:u,pulse:je(l)})),r.operators.pop(),r.pushState(je(l),je(s),null),qn(a,r,!0),r.operators.push(s),i=r.add(qe({mark:u,pulse:je(s)})),i=r.add(rt({pulse:je(i)})),i=r.add(ot({pulse:je(i)})),r.addData("root",new On(r,o,o,i)),r).toRuntime();var a,r,i,o,l,s,u,d},e.config=Xn,e.signal=y,e.signalUpdates=we,e.stream=ve,e.codeGenerator=pe,e.functionContext=oe,e.expressionFunction=fe,e.MarkRole=It,e.FrameRole=Xt,e.ScopeRole=Ht,e.AxisRole="axis",e.AxisDomainRole=Yt,e.AxisGridRole=Gt,e.AxisLabelRole=Jt,e.AxisTickRole=Kt,e.AxisTitleRole=Qt,e.LegendRole="legend",e.LegendEntryRole=Zt,e.LegendLabelRole=en,e.LegendSymbolRole=tn,e.LegendTitleRole=nn,e.Scope=Nn,e.DataScope=On,e.formatLocale=l.formatDefaultLocale,e.timeFormatLocale=s.timeFormatDefaultLocale,Object.defineProperty(e,"__esModule",{value:!0})});