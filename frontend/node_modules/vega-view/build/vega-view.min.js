!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-util"),require("vega-dataflow"),require("vega-scenegraph"),require("d3-array"),require("vega-parser"),require("vega-runtime")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-scenegraph","d3-array","vega-parser","vega-runtime"],n):n(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.d3,e.vega,e.vega)}(this,function(e,n,t,r,i,a,s){"use strict";var u="default",o=function(e){var t=e._signals.cursor;t||(e._signals.cursor=t=e.add({user:u,item:null})),e.on(e.events("view","mousemove"),t,function(e,r){var i=t.value,a=i?n.isString(i)?i:i.user:u,s=r.item&&r.item.cursor||null;return i&&a===i.user&&s==i.item?i:{user:a,item:s}}),e.add(null,function(e){var t,r=e.cursor,i=this.value;return n.isString(r)||(i=r.item,r=r.user),t=r&&r!==u?r:i||r,"undefined"!=typeof document&&document.body&&(document.body.style.cursor=t),i},{cursor:t})};function d(e,t){var r=e._runtime.data;return r.hasOwnProperty(t)||n.error("Unrecognized data set: "+t),r[t]}function l(e,r){t.isChangeSet(r)||n.error("Second argument to changes must be a changeset.");var i=d(this,e);return i.modified=!0,this.pulse(i.input,r)}function c(e){var n=e.padding();return Math.max(0,e._viewWidth+n.left+n.right)}function h(e){var n=e.padding();return Math.max(0,e._viewHeight+n.top+n.bottom)}function f(e){var n=e.padding(),t=e._origin;return[n.left+t[0],n.top+t[1]]}var v=function(e,t,i){var a,s,u,o=e._renderer.scene();return o&&(u=f(e),s=t.changedTouches?t.changedTouches[0]:t,(a=r.point(s,o))[0]-=u[0],a[1]-=u[1]),t.dataflow=e,t.vega=function(e,t,r){var i=t?"group"===t.mark.marktype?t:t.mark.group:null;function a(e){var n,r=i;if(e)for(n=t;n;n=n.mark.group)if(n.mark.name===e){r=n;break}return r&&r.mark&&r.mark.interactive?r:{}}function s(e){if(!e)return r;n.isString(e)&&(e=a(e));for(var t=r.slice();e;)t[0]-=e.x||0,t[1]-=e.y||0,e=e.mark&&e.mark.group;return t}return{view:n.constant(e),item:n.constant(t||{}),group:a,xy:s,x:function(e){return s(e)[0]},y:function(e){return s(e)[1]}}}(e,i,a),t.item=i,t};var g="view",p="window";function _(e){return e.item}function m(e){var n=e.item.mark.source;return n.source||n}function w(e){return function(n,t){return t.vega.view().changeset().encode(t.item,e)}}var y=function(e,n,t){var r=document.createElement(e);for(var i in n)r.setAttribute(i,n[i]);return null!=t&&(r.textContent=t),r},z="vega-bind",b="vega-bind-name",k="vega-bind-radio",L="vega-option-",x=function(e,t,r){if(t){var i=r.param,a=r.state;return a||(a=r.state={elements:null,active:!1,set:null,update:function(n){a.source=!0,e.signal(i.signal,n).run()}},i.debounce&&(a.update=n.debounce(i.debounce,a.update))),function(e,n,t,r){var i=y("div",{class:z});i.appendChild(y("span",{class:b},t.name||t.signal)),n.appendChild(i);var a=C;switch(t.input){case"checkbox":a=S;break;case"select":a=T;break;case"radio":a=E;break;case"range":a=A}a(e,i,t,r)}(a,t,i,e.signal(i.signal)),a.active||(e.on(e._signals[i.signal],null,function(){a.source?a.source=!1:a.set(e.signal(i.signal))}),a.active=!0),a}};function C(e,n,t,r){var i=y("input");for(var a in t)"signal"!==a&&"element"!==a&&i.setAttribute("input"===a?"type":a,t[a]);i.setAttribute("name",t.signal),i.value=r,n.appendChild(i),i.addEventListener("input",function(){e.update(i.value)}),e.elements=[i],e.set=function(e){i.value=e}}function S(e,n,t,r){var i={type:"checkbox",name:t.signal};r&&(i.checked=!0);var a=y("input",i);n.appendChild(a),a.addEventListener("change",function(){e.update(a.checked)}),e.elements=[a],e.set=function(e){a.checked=!!e||null}}function T(e,n,t,r){var i=y("select",{name:t.signal});t.options.forEach(function(e){var n={value:e};H(e,r)&&(n.selected=!0),i.appendChild(y("option",n,e+""))}),n.appendChild(i),i.addEventListener("change",function(){e.update(t.options[i.selectedIndex])}),e.elements=[i],e.set=function(e){for(var n=0,r=t.options.length;n<r;++n)if(H(t.options[n],e))return void(i.selectedIndex=n)}}function E(e,n,t,r){var i=y("span",{class:k});n.appendChild(i),e.elements=t.options.map(function(n){var a=L+t.signal+"-"+n,s={id:a,type:"radio",name:t.signal,value:n};H(n,r)&&(s.checked=!0);var u=y("input",s);return u.addEventListener("change",function(){e.update(n)}),i.appendChild(u),i.appendChild(y("label",{for:a},n+"")),u}),e.set=function(n){for(var t=e.elements,r=0,i=t.length;r<i;++r)H(t[r].value,n)&&(t[r].checked=!0)}}function A(e,n,t,r){r=void 0!==r?r:(+t.max+ +t.min)/2;var a=t.min||Math.min(0,+r)||0,s=t.max||Math.max(100,+r)||100,u=t.step||i.tickStep(a,s,100),o=y("input",{type:"range",name:t.signal,min:a,max:s,step:u});o.value=r;var d=y("label",{},+r);function l(){d.textContent=o.value,e.update(+o.value)}n.appendChild(o),n.appendChild(d),o.addEventListener("input",l),o.addEventListener("change",l),e.elements=[o],e.set=function(e){o.value=e,d.textContent=e}}function H(e,n){return e===n||e+""==n+""}var R=function(e,n,t,r,i){return(n=n||new r(e.loader())).initialize(t,c(e),h(e),f(e),i).background(e._background)};function D(e,n){if("string"==typeof n){if("undefined"==typeof document)return e.error("DOM document instance not found."),null;if(!(n=document.querySelector(n)))return e.error("Signal bind element not found: "+n),null}if(n)try{n.innerHTML=""}catch(t){n=null,e.error(t)}return n}var M=function(e,n,t){var i=r.renderModule(n),a=i&&i.headless;return a?e.runAsync().then(function(){return R(e,null,null,a,t).renderAsync(e._scenegraph.root)}):Promise.reject("Unrecognized renderer type: "+n)};var U=function(e,n,r){var i=r||a.functionContext;return s.parse(n,s.context(e,t.transforms,i))},q="padding";function O(e,n){var t=e.autosize(),r=e.padding();return n-(t&&t.contains===q?r.left+r.right:0)}function W(e,n){var t=e.autosize(),r=e.padding();return n-(t&&t.contains===q?r.top+r.bottom:0)}function V(e,t){return t.modified&&n.isArray(t.input.value)&&e.indexOf("_:vega:_")}function P(e,n){return!("parent"===e||n instanceof t.transforms.proxy)}function j(e,i){var a=this;i=i||{},t.Dataflow.call(a),a.loader(i.loader||a._loader),a.logLevel(i.logLevel||0),a._el=null,a._renderType=i.renderer||r.RenderType.Canvas,a._scenegraph=new r.Scenegraph;var s=a._scenegraph.root;a._renderer=null,a._redraw=!0,a._handler=(new r.CanvasHandler).scene(s),a._preventDefault=!1,a._eventListeners=[],a._resizeListeners=[];var u,d,l=U(a,e,i.functions);a._runtime=l,a._signals=l.signals,a._bind=(e.bindings||[]).map(function(e){return{state:null,param:n.extend({},e)}}),l.root&&l.root.set(s),s.source=l.data.root.input,a.pulse(l.data.root.input,a.changeset().insert(s.items)),a._background=l.background||null,a._eventConfig=(u=l.eventConfig,(d=(u=n.extend({},u)).defaults)&&(n.isArray(d.prevent)&&(d.prevent=n.toSet(d.prevent)),n.isArray(d.allow)&&(d.allow=n.toSet(d.allow))),u),a._width=a.width(),a._height=a.height(),a._viewWidth=O(a,a._width),a._viewHeight=W(a,a._height),a._origin=[0,0],a._resize=0,a._autosize=1,function(e){var n=e._signals,t=n.width,r=n.height,i=n.padding;function a(){e._autosize=e._resize=1}e._resizeWidth=e.add(null,function(n){e._width=n.size,e._viewWidth=O(e,n.size),a()},{size:t}),e._resizeHeight=e.add(null,function(n){e._height=n.size,e._viewHeight=W(e,n.size),a()},{size:r});var s=e.add(null,a,{pad:i});e._resizeWidth.rank=t.rank+1,e._resizeHeight.rank=r.rank+1,s.rank=i.rank+1}(a),o(a)}var G=n.inherits(j,t.Dataflow);function I(e,t){return e._signals.hasOwnProperty(t)?e._signals[t]:n.error("Unrecognized signal name: "+n.stringValue(t))}function B(e,n){var t=(e._targets||[]).filter(function(e){var t=e._update;return t&&t.handler===n});return t.length?t[0]:null}G.run=function(e){if(t.Dataflow.prototype.run.call(this,e),this._redraw||this._resize)try{this.render()}catch(e){this.error(e)}return this},G.render=function(){var e,n,t,r;return this._renderer&&(this._resize&&(this._resize=0,n=f(e=this),t=c(e),r=h(e),e._renderer.background(e._background),e._renderer.resize(t,r,n),e._handler.origin(n),e._resizeListeners.forEach(function(e){e(t,r)})),this._renderer.render(this._scenegraph.root)),this._redraw=!1,this},G.dirty=function(e){this._redraw=!0,this._renderer&&this._renderer.dirty(e)},G.container=function(){return this._el},G.scenegraph=function(){return this._scenegraph},G.signal=function(e,n,t){var r=I(this,e);return 1===arguments.length?r.value:this.update(r,n,t)},G.background=function(e){return arguments.length?(this._background=e,this._resize=1,this):this._background},G.width=function(e){return arguments.length?this.signal("width",e):this.signal("width")},G.height=function(e){return arguments.length?this.signal("height",e):this.signal("height")},G.padding=function(e){return arguments.length?this.signal("padding",e):this.signal("padding")},G.autosize=function(e){return arguments.length?this.signal("autosize",e):this.signal("autosize")},G.renderer=function(e){return arguments.length?(r.renderModule(e)||n.error("Unrecognized renderer type: "+e),e!==this._renderType&&(this._renderType=e,this._renderer&&(this._renderer=null,this.initialize(this._el))),this):this._renderType},G.loader=function(e){return arguments.length?(e!==this._loader&&(t.Dataflow.prototype.loader.call(this,e),this._renderer&&(this._renderer=null,this.initialize(this._el))),this):this._loader},G.resize=function(){return this._autosize=1,this},G._resizeView=function(e,n,t,r,i,a){this.runAfter(function(s){var u=0;s._autosize=0,s.width()!==t&&(u=1,s.width(t),s._resizeWidth.skip(!0)),s.height()!==r&&(u=1,s.height(r),s._resizeHeight.skip(!0)),s._viewWidth!==e&&(s._resize=1,s._viewWidth=e),s._viewHeight!==n&&(s._resize=1,s._viewHeight=n),s._origin[0]===i[0]&&s._origin[1]===i[1]||(s._resize=1,s._origin=i),u&&s.run("enter"),a&&s.runAfter(function(){s.resize()})},!1,1)},G.addEventListener=function(e,n){return this._handler.on(e,n),this},G.removeEventListener=function(e,n){return this._handler.off(e,n),this},G.addResizeListener=function(e){var n=this._resizeListeners;return n.indexOf(e)<0&&n.push(e),this},G.removeResizeListener=function(e){var n=this._resizeListeners,t=n.indexOf(e);return t>=0&&n.splice(t,1),this},G.addSignalListener=function(e,n){var t=I(this,e),r=B(t,n);return r||((r=function(){n(e,t.value)}).handler=n,this.on(t,null,r)),this},G.removeSignalListener=function(e,n){var t=I(this,e),r=B(t,n);return r&&t._targets.remove(r),this},G.preventDefault=function(e){return arguments.length?(this._preventDefault=e,this):this._preventDefault},G.tooltipHandler=function(e){var n=this._handler;return arguments.length?(n.handleTooltip=e||r.Handler.prototype.handleTooltip,this):n.handleTooltip},G.events=function(e,n,r){var i,a=this,s=new t.EventStream(r),u=function(t,r){var i,u,o,d,l;e!==g||(u=n,o=(i=a)._eventConfig.defaults,d=o&&o.prevent,l=o&&o.allow,!1===d||!0===l||!0!==d&&!1!==l&&(d?!d[u]:l?l[u]:!i.preventDefault()))||t.preventDefault();try{s.receive(v(a,t,r))}catch(e){a.error(e)}finally{a.run()}};if(e===g)return a.addEventListener(n,u),s;if(e===p?"undefined"!=typeof window&&(i=[window]):"undefined"!=typeof document&&(i=document.querySelectorAll(e)),!i)return a.warn("Can not resolve event source: "+e),s;for(var o=0,d=i.length;o<d;++o)i[o].addEventListener(n,u);return a._eventListeners.push({type:n,sources:i,handler:u}),s},G.finalize=function(){for(var e,n,t=this._eventListeners,r=t.length;--r>=0;)for(e=(n=t[r]).sources.length;--e>=0;)n.sources[e].removeEventListener(n.type,n.handler)},G.hover=function(e,n){return n=[n||"update",e=[e||"hover"]],this.on(this.events("view","mouseover",_),m,w(e)),this.on(this.events("view","mouseout",_),m,w(n)),this},G.data=function(e){return d(this,e).values.value},G.change=l,G.insert=function(e,n){return l.call(this,e,t.changeset().insert(n))},G.remove=function(e,n){return l.call(this,e,t.changeset().remove(n))},G.initialize=function(e,n){var t,i,a,s,u,o,d=this,l=d._renderType,c=r.renderModule(l);return e=d._el=e?D(d,e):null,c||d.error("Unrecognized renderer type: "+l),t=c.handler||r.CanvasHandler,i=e?c.renderer:c.headless,d._renderer=i?R(d,d._renderer,e,i):null,d._handler=(a=d,s=d._handler,u=e,o=new t(a.loader()).scene(a.scenegraph().root).initialize(u,f(a),a),s&&(o.handleTooltip=s.handleTooltip,s.handlers().forEach(function(e){o.on(e.type,e.handler)})),o),d._redraw=!0,e&&(n=n?D(d,n):e.appendChild(y("div",{class:"vega-bindings"})),d._bind.forEach(function(e){e.param.element&&(e.element=D(d,e.param.element))}),d._bind.forEach(function(e){x(d,e.element||n,e)})),d},G.toImageURL=function(e,n){return e!==r.RenderType.Canvas&&e!==r.RenderType.SVG&&e!==r.RenderType.PNG?Promise.reject("Unrecognized image type: "+e):M(this,e,n).then(function(n){return e===r.RenderType.SVG?(t=n.svg(),i=new Blob([t],{type:"image/svg+xml"}),window.URL.createObjectURL(i)):n.canvas().toDataURL("image/png");var t,i})},G.toCanvas=function(e){return M(this,r.RenderType.Canvas,e).then(function(e){return e.canvas()})},G.toSVG=function(e){return M(this,r.RenderType.SVG,e).then(function(e){return e.svg()})},G.getState=function(e){return this._runtime.getState(e||{data:V,signals:P,recurse:!0})},G.setState=function(e){var n=this;return n.runAfter(function(){n._trigger=!1,n._runtime.setState(e),n.run().runAfter(function(){n._trigger=!0})}),this},e.View=j,Object.defineProperty(e,"__esModule",{value:!0})});