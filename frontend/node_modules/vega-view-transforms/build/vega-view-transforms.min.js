!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util"],t):t((n.vega=n.vega||{},n.vega.transforms=n.vega.transforms||{}),n.vega,n.vega,n.vega)}(this,function(n,t,e,o){"use strict";function r(n){t.Transform.call(this,null,n)}function a(n,t,e){return t(n.bounds.clear(),n,e)}function i(n){t.Transform.call(this,0,n)}function u(n){t.Transform.call(this,null,n)}function s(n){t.Transform.call(this,null,n)}function d(n,t){return!(n.x2-1<t.x1||n.x1+1>t.x2||n.y2-1<t.y1||n.y1+1>t.y2)}function l(n){for(var t,e=1,o=n.length,r=n[0].bounds;e<o;r=t,++e)if(d(r,t=n[e].bounds))return!0}function c(n){var t=n.bounds;return t.width()>1&&t.height()>1}function f(n){t.Transform.call(this,null,n)}function h(n,t){for(var e=0,o=n.length;e<o;++e)t.push(n[e])}function m(n,t,e){var r=o.isObject(n)?n[t]:n;return null!=r?r:void 0!==e?e:0}function b(n){return n<0?Math.ceil(-n):0}function y(n,t,o){function r(n,t){return Math.floor(Math.min(n,t))}function a(n,t){return Math.ceil(Math.max(n,t))}var i,u,s,d,l,c,f,y,p,v,w,k,M,T=function(n){for(var t,e,o=n.items,r=o.length,a=0,i={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};a<r;++a)if(t=o[a],e=t.items,"group"===t.marktype)switch(t.role){case _:case O:break;case j:h(e,i.rowheaders);break;case S:h(e,i.rowfooters);break;case A:h(e,i.colheaders);break;case I:h(e,i.colfooters);break;case q:i.rowtitle=e[0];break;case C:i.coltitle=e[0];break;default:h(e,i.marks)}return i}(t),z=T.marks,E="flush"===o.bounds,B=E?function(n){return{x1:0,y1:0,x2:n.width||0,y2:n.height||0}}:function(n){var t=n.bounds.clone();return t.empty()?t.set(0,0,0,0):t.translate(-(n.x||0),-(n.y||0))},D=new e.Bounds(0,0,0,0),F=m(o.align,"column"),G=m(o.align,"row"),H=m(o.padding,"column"),L=m(o.padding,"row"),P=o.offset,R=t.columns||o.columns||z.length,U=R<0?1:Math.ceil(z.length/R),V=U*R,W=[],J=[],K=[],N=[],Q=z.length;for(u=0;u<R;++u)J[u]=0;for(u=0;u<U;++u)N[u]=0;for(u=0;u<Q;++u)l=B(z[u]),d=~~(u/R),f=(s=u%R)?Math.ceil(B(z[u-1]).x2):0,y=d?Math.ceil(B(z[u-R]).y2):0,J[s]=Math.max(J[s],f),N[d]=Math.max(N[d],y),W.push(H+b(l.x1)),K.push(L+b(l.y1)),n.dirty(z[u]);for(u=0;u<Q;++u)u%R==0&&(W[u]=0),u<R&&(K[u]=0);if("each"===F)for(s=1;s<R;++s){for(M=0,u=s;u<Q;u+=R)M<W[u]&&(M=W[u]);for(u=s;u<Q;u+=R)W[u]=M+J[s]}else if("all"===F){for(k=0,s=1;s<R;++s)k<J[s]&&(k=J[s]);for(M=0,u=0;u<Q;++u)u%R&&M<W[u]&&(M=W[u]);for(u=0;u<Q;++u)u%R&&(W[u]=M+k)}else for(s=1;s<R;++s)for(u=s;u<Q;u+=R)W[u]+=J[s];if("each"===G)for(d=1;d<U;++d){for(M=0,i=(u=d*R)+R;u<i;++u)M<K[u]&&(M=K[u]);for(u=d*R;u<i;++u)K[u]=M+N[d]}else if("all"===G){for(k=0,d=1;d<U;++d)k<N[d]&&(k=N[d]);for(M=0,u=R;u<Q;++u)M<K[u]&&(M=K[u]);for(u=R;u<Q;++u)K[u]=M+k}else for(d=1;d<U;++d)for(i=(u=d*R)+R;u<i;++u)K[u]+=N[d];for(p=0,u=0;u<Q;++u)f=(c=z[u]).x||0,c.x=p=W[u]+(u%R?p:0),c.bounds.translate(p-f,0);for(s=0;s<R;++s)for(v=0,u=s;u<Q;u+=R)y=(c=z[u]).y||0,c.y=v+=K[u],c.bounds.translate(0,v-y);for(u=0;u<Q;++u)z[u].mark.bounds.clear();for(u=0;u<Q;++u)c=z[u],n.dirty(c),D.union(c.mark.bounds.union(c.bounds));B=E?function(n,t){return"x1"===t?n.x||0:"y1"===t?n.y||0:"x2"===t?(n.x||0)+(n.width||0):"y2"===t?(n.y||0)+(n.height||0):void 0}:function(n,t){return n.bounds[t]},w=m(o.headerBand,"row",null),p=g(n,T.rowheaders,z,R,U,-m(P,"rowHeader"),r,0,B,"x1",0,R,1,w),w=m(o.headerBand,"column",null),v=g(n,T.colheaders,z,R,R,-m(P,"columnHeader"),r,1,B,"y1",0,1,R,w),w=m(o.footerBand,"row",null),g(n,T.rowfooters,z,R,U,m(P,"rowFooter"),a,0,B,"x2",R-1,R,1,w),w=m(o.footerBand,"column",null),g(n,T.colfooters,z,R,R,m(P,"columnFooter"),a,1,B,"y2",V-R,1,R,w),T.rowtitle&&(M=p-m(P,"rowTitle"),w=m(o.titleBand,"row",.5),x(n,T.rowtitle,M,0,D,w)),T.coltitle&&(M=v-m(P,"columnTitle"),w=m(o.titleBand,"column",.5),x(n,T.coltitle,M,1,D,w))}function g(n,t,e,o,r,a,i,u,s,d,l,c,f,h){var m,b,y,g,x,p,v,w,k,M=e.length,T=0,z=0;if(!M)return T;for(m=l;m<M;m+=c)e[m]&&(T=i(T,s(e[m],d)));if(!t.length)return T;for(t.length>r&&(n.warn("Grid headers exceed limit: "+r),t=t.slice(0,r)),T+=a,b=0,g=t.length;b<g;++b)n.dirty(t[b]),t[b].mark.bounds.clear();for(m=l,b=0,g=t.length;b<g;++b,m+=c){for(x=(p=t[b]).mark.bounds,y=m;y>=0&&null==(v=e[y]);y-=f);u?(w=null==h?v.x:Math.round(v.bounds.x1+h*v.bounds.width()),k=T):(w=T,k=null==h?v.y:Math.round(v.bounds.y1+h*v.bounds.height())),x.union(p.bounds.translate(w-(p.x||0),k-(p.y||0))),p.x=w,p.y=k,n.dirty(p),z=i(z,x[d])}return z}function x(n,t,e,o,r,a){if(t){n.dirty(t);var i=e,u=e;o?i=Math.round(r.x1+a*r.width()):u=Math.round(r.y1+a*r.height()),t.bounds.translate(i-(t.x||0),u-(t.y||0)),t.mark.bounds.clear().union(t.bounds),t.x=i,t.y=u,n.dirty(t)}}function p(n){t.Transform.call(this,null,n)}function v(n,t,o){var r,a,i,u,s,d,l=t.items,c=Math.max(0,t.width||0),f=Math.max(0,t.height||0),h=(new e.Bounds).set(0,0,c,f),m=h.clone(),b=h.clone(),y=h.clone(),g=[];for(s=0,d=l.length;s<d;++s)switch((a=l[s]).role){case U:m.union(u=function(n,t,o,r){var a,i,u=t.items[0],s=u.datum,d=s.orient,l=function(n){var t=+n.grid;return[n.ticks?t++:-1,n.labels?t++:-1,t+ +n.domain]}(s),c=u.range,f=u.offset,h=u.position,m=u.minExtent,b=u.maxExtent,y=s.title&&u.items[l[2]].items[0],g=u.titlePadding,x=u.bounds,p=0,v=0;$.clear().union(x),x.clear(),(a=l[0])>-1&&x.union(u.items[a].bounds);(a=l[1])>-1&&x.union(u.items[a].bounds);switch(d){case T:p=h||0,v=-f,i=Math.max(m,Math.min(b,-x.y1)),y&&(y.auto?(i+=g,y.y=-i,i+=y.bounds.height(),x.add(y.bounds.x1,0).add(y.bounds.x2,0)):x.union(y.bounds)),x.add(0,-i).add(c,0);break;case z:p=-f,v=h||0,i=Math.max(m,Math.min(b,-x.x1)),y&&(y.auto?(i+=g,y.x=-i,i+=y.bounds.width(),x.add(0,y.bounds.y1).add(0,y.bounds.y2)):x.union(y.bounds)),x.add(-i,0).add(0,c);break;case E:p=o+f,v=h||0,i=Math.max(m,Math.min(b,x.x2)),y&&(y.auto?(i+=g,y.x=i,i+=y.bounds.width(),x.add(0,y.bounds.y1).add(0,y.bounds.y2)):x.union(y.bounds)),x.add(0,0).add(i,c);break;case B:p=h||0,v=r+f,i=Math.max(m,Math.min(b,x.y2)),y&&(y.auto?(i+=g,y.y=i,i+=y.bounds.height(),x.add(y.bounds.x1,0).add(y.bounds.x2,0)):x.union(y.bounds)),x.add(0,0).add(c,i);break;default:p=u.x,v=u.y}e.boundStroke(x.translate(p,v),u),w(u,"x",p+Z)|w(u,"y",v+Z)&&(u.bounds=$,n.dirty(u),u.bounds=x,n.dirty(u));return u.mark.bounds.clear().union(x)}(n,a,c,f)),(k(a)?b:y).union(u);break;case V:r=a;break;case J:g.push(a);break;case W:case K:case N:case Q:case X:case Y:b.union(a.bounds),y.union(a.bounds);break;default:h.union(a.bounds)}if(r&&(m.union(u=function(n,t,e){var o=t.items[0],r=o.datum.orient,a=o.offset,i=o.bounds,u=0,s=0;switch($.clear().union(i),r){case T:u=o.x,s=e.y1-a;break;case z:u=e.x1-a,s=o.y;break;case E:u=e.x2+a,s=o.y;break;case B:u=o.x,s=e.y2+a;break;default:u=o.x,s=o.y}i.translate(u-o.x,s-o.y),w(o,"x",u)|w(o,"y",s)&&(o.bounds=$,n.dirty(o),o.bounds=i,n.dirty(o));return t.bounds.clear().union(i)}(n,r,m)),(k(r)?b:y).union(u)),g.length)for(i={left:0,right:0,top:0,bottom:0,margin:o.legendMargin||8},s=0,d=g.length;s<d;++s)if(u=function(n,t,o,r,a,i,u){var s,d,l,c=t.items[0],f=c.datum.orient,h=c.offset,m=c.bounds,b=0,y=0;f===T||f===B?(l=a,b=o[f]):f!==z&&f!==E||(l=r,y=o[f]);switch($.clear().union(m),m.clear(),c.items.forEach(function(n){m.union(n.bounds)}),s=Math.round(m.width())+2*c.padding-1,d=Math.round(m.height())+2*c.padding-1,f){case z:b-=s+h-Math.floor(l.x1),o.left+=d+o.margin;break;case E:b+=h+Math.ceil(l.x2),o.right+=d+o.margin;break;case T:y-=d+h-Math.floor(l.y1),o.top+=s+o.margin;break;case B:y+=h+Math.ceil(l.y2),o.bottom+=s+o.margin;break;case"top-left":b+=h,y+=h;break;case"top-right":b+=i-s-h,y+=h;break;case"bottom-left":b+=h,y+=u-d-h;break;case"bottom-right":b+=i-s-h,y+=u-d-h;break;default:b=c.x,y=c.y}e.boundStroke(m.set(b,y,b+s,y+d),c),w(c,"x",b)|w(c,"width",s)|w(c,"y",y)|w(c,"height",d)&&(c.bounds=$,n.dirty(c),c.bounds=m,n.dirty(c));return c.mark.bounds.clear().union(m)}(n,g[s],i,b,y,c,f),o.autosize&&o.autosize.type===F){var x=g[s].items[0].datum.orient;x===z||x===E?h.add(u.x1,0).add(u.x2,0):x!==T&&x!==B||h.add(0,u.y1).add(0,u.y2)}else h.union(u);h.union(b).union(y).union(m),function(n,t,e,o){var r=o.autosize||{},a=r.type,i=n._width,u=n._height,s=n.padding();if(n._autosize<1||!a)return;var d=Math.max(0,t.width||0),l=Math.max(0,Math.ceil(-e.x1)),c=Math.max(0,Math.ceil(e.x2-d)),f=Math.max(0,t.height||0),h=Math.max(0,Math.ceil(-e.y1)),m=Math.max(0,Math.ceil(e.y2-f));r.contains===R&&(i-=s.left+s.right,u-=s.top+s.bottom);a===P?(l=0,h=0,d=i,f=u):a===F?(d=Math.max(0,i-l-c),f=Math.max(0,u-h-m)):a===G?(d=Math.max(0,i-l-c),u=f+h+m):a===H?(i=d+l+c,f=Math.max(0,u-h-m)):a===L&&(i=d+l+c,u=f+h+m);n._resizeView(i,u,d,f,[l,h],r.resize)}(n,t,h,o)}function w(n,t,e){return n[t]===e?0:(n[t]=e,1)}function k(n){var t=n.items[0].datum.orient;return t===z||t===E}o.inherits(r,t.Transform).transform=function(n,t){var o,r=t.dataflow,i=n.mark,u=i.marktype,s=e.Marks[u],d=s.bound,l=i.bounds;return s.nested?(i.items.length&&r.dirty(i.items[0]),l=a(i,d),i.items.forEach(function(n){n.bounds.clear().union(l)})):"group"===u||n.modified()?(t.visit(t.MOD,function(n){r.dirty(n)}),l.clear(),i.items.forEach(function(n){l.union(a(n,d))})):(o=t.changed(t.REM),t.visit(t.ADD,function(n){l.union(a(n,d))}),t.visit(t.MOD,function(n){o=o||l.alignsWith(n.bounds),r.dirty(n),l.union(a(n,d))}),o&&(l.clear(),i.items.forEach(function(n){l.union(n.bounds)}))),e.boundClip(i),t.modifies("bounds")};var M=":vega_identifier:";i.Definition={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]};o.inherits(i,t.Transform).transform=function(n,t){var e=function(n){var t=n._signals[M];return t||(n._signals[M]=t=n.add(0)),t}(t.dataflow),o=e.value,r=n.as;return t.visit(t.ADD,function(n){n[r]||(n[r]=++o)}),e.set(this.value=o),t};o.inherits(u,t.Transform).transform=function(n,t){var o=this.value;o||((o=t.dataflow.scenegraph().mark(n.markdef,function(n){var t=n.groups,e=n.parent;return t&&1===t.size?t.get(Object.keys(t.object)[0]):t&&e?t.lookup(e):null}(n),n.index)).group.context=n.context,n.context.group||(n.context.group=o.group),o.source=this,o.clip=n.clip,o.interactive=n.interactive,this.value=o);var r="group"===o.marktype?e.GroupItem:e.Item;return t.visit(t.ADD,function(n){r.call(n,o)}),(n.modified("clip")||n.modified("interactive"))&&(o.clip=n.clip,o.interactive=!!n.interactive,o.zdirty=!0,t.reflow()),o.items=t.source,t};var T="top",z="left",E="right",B="bottom",D={parity:function(n){return n.filter(function(n,t){return t%2?n.opacity=0:1})},greedy:function(n){var t;return n.filter(function(n,e){return e&&d(t.bounds,n.bounds)?n.opacity=0:(t=n,1)})}};o.inherits(s,t.Transform).transform=function(n,t){var r=D[n.method]||D.parity,a=t.materialize(t.SOURCE).source;if(a){n.sort&&(a=a.slice().sort(n.sort)),"greedy"===n.method&&(a=a.filter(c)),a.forEach(function(n){n.opacity=1});var i=a;if(i.length>=3&&l(i)){t=t.reflow(n.modified()).modifies("opacity");do{i=r(i)}while(i.length>=3&&l(i));i.length<3&&!o.peek(a).opacity&&(i.length>1&&(o.peek(i).opacity=0),o.peek(a).opacity=1)}if(n.boundScale){var u=function(n,t,o){var r=n.range(),a=new e.Bounds;return t===T||t===B?a.set(r[0],-1/0,r[1],1/0):a.set(-1/0,r[0],1/0,r[1]),a.expand(o||1),function(n){return a.encloses(n.bounds)}}(n.boundScale,n.boundOrient,n.boundTolerance);a.forEach(function(n){u(n)||(n.opacity=0)})}return t}};o.inherits(f,t.Transform).transform=function(n,t){var e=t.dataflow;if(t.visit(t.ALL,function(n){e.dirty(n)}),t.fields&&t.fields.zindex){var o=t.source&&t.source[0];o&&(o.mark.zdirty=!0)}};var _="axis",O="legend",j="row-header",S="row-footer",q="row-title",A="column-header",I="column-footer",C="column-title",F="fit",G="fit-x",H="fit-y",L="pad",P="none",R="padding",U="axis",V="title",W="frame",J="legend",K="scope",N="row-header",Q="row-footer",X="column-header",Y="column-footer",Z=.5,$=new e.Bounds;o.inherits(p,t.Transform).transform=function(n,t){var e=t.dataflow;return n.mark.items.forEach(function(t){n.layout&&y(e,t,n.layout),v(e,t,n)}),t},n.bound=r,n.identifier=i,n.mark=u,n.overlap=s,n.render=f,n.viewlayout=p,Object.defineProperty(n,"__esModule",{value:!0})});